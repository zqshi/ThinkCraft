/**
 * å•†ä¸šè®¡åˆ’ä¹¦ç”Ÿæˆ API
 * æ”¯æŒå•ç« èŠ‚ç”Ÿæˆå’Œæ‰¹é‡ç”Ÿæˆ
 */
import express from 'express';
import { callDeepSeekAPI, getCostStats } from '../../../../config/deepseek.js';

const router = express.Router();

// å•†ä¸šè®¡åˆ’ä¹¦ç« èŠ‚æç¤ºè¯æ¨¡æ¿
const CHAPTER_PROMPTS = {
    executive_summary: `ä½ æ˜¯èµ„æ·±å•†ä¸šåˆ†æå¸ˆã€‚åŸºäºç”¨æˆ·ä¸AIçš„åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€æ‰§è¡Œæ‘˜è¦ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š800-1000å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. ä¸šåŠ¡æ¦‚è¿°ï¼ˆ2-3å¥è¯è¯´æ˜æ˜¯ä»€ä¹ˆï¼‰
  2. å¸‚åœºæœºä¼šï¼ˆç›®æ ‡å¸‚åœºè§„æ¨¡ã€å¢é•¿è¶‹åŠ¿ï¼‰
  3. è§£å†³æ–¹æ¡ˆï¼ˆæ ¸å¿ƒä»·å€¼ä¸»å¼ ï¼‰
  4. å•†ä¸šæ¨¡å¼ï¼ˆå¦‚ä½•èµšé’±ï¼‰
  5. ç«äº‰ä¼˜åŠ¿ï¼ˆä¸ºä»€ä¹ˆæ˜¯æˆ‘ä»¬ï¼‰
  6. èèµ„éœ€æ±‚ï¼ˆå¦‚æœå¯¹è¯ä¸­æåˆ°ï¼‰

åˆ†æåŸåˆ™ï¼š
- åŸºäºå¯¹è¯ä¸­æ˜ç¡®æåˆ°çš„ä¿¡æ¯
- å¦‚æœä¿¡æ¯ä¸è¶³ï¼Œç”¨"å»ºè®®è¿›ä¸€æ­¥è°ƒç ”"ç­‰è¡¨è¿°
- å®¢è§‚ä¸­ç«‹ï¼Œæ—¢è¦å±•ç¤ºæœºä¼šä¹Ÿè¦æç¤ºé£é™©
- è¯­è¨€ä¸“ä¸šä½†æ˜“æ‡‚

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    market_analysis: `ä½ æ˜¯å¸‚åœºç ”ç©¶ä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€å¸‚åœºåˆ†æã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š1000-1200å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. å¸‚åœºè§„æ¨¡åˆ†æï¼ˆTAM/SAM/SOMï¼‰
  2. ç›®æ ‡ç”¨æˆ·ç”»åƒï¼ˆäººå£ç»Ÿè®¡ã€è¡Œä¸ºç‰¹å¾ï¼‰
  3. ç”¨æˆ·ç—›ç‚¹åˆ†æï¼ˆæ ¸å¿ƒé—®é¢˜æ˜¯ä»€ä¹ˆï¼‰
  4. å¸‚åœºè¶‹åŠ¿ï¼ˆå¢é•¿åŠ¨åŠ›ã€é©±åŠ¨å› ç´ ï¼‰
  5. å¸‚åœºæœºä¼šï¼ˆä¸ºä»€ä¹ˆç°åœ¨æ˜¯å¥½æ—¶æœºï¼‰

åˆ†æè¦æ±‚ï¼š
- ä½¿ç”¨è¡Œä¸šé€šç”¨æ•°æ®ï¼ˆå¦‚"ä¸­å›½XXå¸‚åœºè§„æ¨¡çº¦XXXäº¿"ï¼‰
- æ ‡æ³¨æ•°æ®æ¥æºæˆ–æ³¨æ˜"å‚è€ƒè¡Œä¸šæ•°æ®"
- å®¢è§‚åˆ†æå¸‚åœºç°çŠ¶å’Œæœªæ¥æ½œåŠ›

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    solution: `ä½ æ˜¯äº§å“æˆ˜ç•¥é¡¾é—®ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€è§£å†³æ–¹æ¡ˆã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š900-1100å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. äº§å“å®šä½ï¼ˆä¸€å¥è¯ä»·å€¼ä¸»å¼ ï¼‰
  2. æ ¸å¿ƒåŠŸèƒ½ï¼ˆ3-5ä¸ªä¸»è¦åŠŸèƒ½ï¼‰
  3. æŠ€æœ¯æ–¹æ¡ˆï¼ˆæŠ€æœ¯é€‰å‹ã€æ¶æ„äº®ç‚¹ï¼‰
  4. å·®å¼‚åŒ–ä¼˜åŠ¿ï¼ˆä¸ç«å“çš„åŒºåˆ«ï¼‰
  5. äº§å“è·¯çº¿å›¾ï¼ˆMVP â†’ è¿­ä»£æ–¹å‘ï¼‰

åˆ†æè¦æ±‚ï¼š
- æ¸…æ™°æè¿°äº§å“å¦‚ä½•è§£å†³ç”¨æˆ·ç—›ç‚¹
- æŠ€æœ¯æ–¹æ¡ˆè¦å®é™…å¯è¡Œ
- å¼ºè°ƒç‹¬ç‰¹æ€§å’Œåˆ›æ–°æ€§

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    business_model: `ä½ æ˜¯å•†ä¸šæ¨¡å¼è®¾è®¡ä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€å•†ä¸šæ¨¡å¼ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š800-1000å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. æ”¶å…¥æ¨¡å¼ï¼ˆå¦‚ä½•èµšé’±ï¼‰
  2. å®šä»·ç­–ç•¥ï¼ˆä»·æ ¼ä½“ç³»ã€å®šä»·ä¾æ®ï¼‰
  3. æˆæœ¬ç»“æ„ï¼ˆä¸»è¦æˆæœ¬é¡¹ï¼‰
  4. ç›ˆåˆ©é¢„æµ‹ï¼ˆä½•æ—¶ç›ˆäºå¹³è¡¡ï¼‰
  5. è§„æ¨¡åŒ–è·¯å¾„ï¼ˆå¦‚ä½•æ‰©å¤§æ”¶å…¥ï¼‰

åˆ†æè¦æ±‚ï¼š
- å•†ä¸šæ¨¡å¼è¦æ¸…æ™°å¯è¡Œ
- å®šä»·è¦åˆç†ä¸”æœ‰ç«äº‰åŠ›
- æˆæœ¬ä¼°ç®—è¦å®é™…

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    competitive_landscape: `ä½ æ˜¯ç«äº‰åˆ†æä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€ç«äº‰æ ¼å±€ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š900-1100å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. ç«äº‰å¯¹æ‰‹åˆ†æï¼ˆåˆ—ä¸¾3-5ä¸ªä¸»è¦ç«å“ï¼‰
  2. ç«äº‰ä¼˜åŠ¿å¯¹æ¯”ï¼ˆåŠŸèƒ½ã€ä»·æ ¼ã€ä½“éªŒç­‰ï¼‰
  3. å·®å¼‚åŒ–ç­–ç•¥ï¼ˆå¦‚ä½•è„±é¢–è€Œå‡ºï¼‰
  4. è¿›å…¥å£å’ï¼ˆæˆ‘ä»¬çš„æŠ¤åŸæ²³ï¼‰
  5. ç«äº‰é£é™©ï¼ˆå¯èƒ½çš„å¨èƒï¼‰

åˆ†æè¦æ±‚ï¼š
- å®¢è§‚è¯„ä»·ç«å“ä¼˜åŠ£
- æ¸…æ™°é˜è¿°å·®å¼‚åŒ–ä¼˜åŠ¿
- è¯†åˆ«çœŸå®çš„ç«äº‰é£é™©

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    marketing_strategy: `ä½ æ˜¯è¥é”€ç­–ç•¥ä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€å¸‚åœºç­–ç•¥ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š900-1100å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. ç›®æ ‡å®¢æˆ·è·å–ï¼ˆå¦‚ä½•æ‰¾åˆ°ç¬¬ä¸€æ‰¹ç”¨æˆ·ï¼‰
  2. è¥é”€æ¸ é“ï¼ˆçº¿ä¸Š/çº¿ä¸‹æ¸ é“ï¼‰
  3. å“ç‰Œå®šä½ï¼ˆå“ç‰Œè°ƒæ€§ã€ä¼ æ’­ç­–ç•¥ï¼‰
  4. å¢é•¿ç­–ç•¥ï¼ˆå¦‚ä½•å®ç°ç”¨æˆ·å¢é•¿ï¼‰
  5. è¥é”€é¢„ç®—ï¼ˆå„æ¸ é“é¢„ç®—åˆ†é…ï¼‰

åˆ†æè¦æ±‚ï¼š
- è¥é”€ç­–ç•¥è¦å…·ä½“å¯æ‰§è¡Œ
- æ¸ é“é€‰æ‹©è¦ç¬¦åˆç›®æ ‡ç”¨æˆ·ç‰¹å¾
- é¢„ç®—åˆ†é…è¦åˆç†

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    team_structure: `ä½ æ˜¯ç»„ç»‡æ¶æ„é¡¾é—®ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€å›¢é˜Ÿæ¶æ„ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š700-900å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. æ ¸å¿ƒå›¢é˜Ÿï¼ˆåˆ›å§‹å›¢é˜ŸèƒŒæ™¯ï¼‰
  2. ç»„ç»‡æ¶æ„ï¼ˆéƒ¨é—¨è®¾ç½®ã€èŒè´£åˆ†å·¥ï¼‰
  3. äººæ‰éœ€æ±‚ï¼ˆå…³é”®å²—ä½ã€æ‹›è˜è®¡åˆ’ï¼‰
  4. è‚¡æƒæ¿€åŠ±ï¼ˆæœŸæƒæ± ã€æ¿€åŠ±æœºåˆ¶ï¼‰
  5. å›¢é˜Ÿæ–‡åŒ–ï¼ˆä»·å€¼è§‚ã€å·¥ä½œæ–¹å¼ï¼‰

åˆ†æè¦æ±‚ï¼š
- å›¢é˜ŸèƒŒæ™¯è¦ä¸ä¸šåŠ¡åŒ¹é…
- ç»„ç»‡æ¶æ„è¦é€‚åº”å½“å‰é˜¶æ®µ
- äººæ‰éœ€æ±‚è¦å…·ä½“

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    financial_projection: `ä½ æ˜¯è´¢åŠ¡åˆ†æä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€è´¢åŠ¡é¢„æµ‹ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š1000-1200å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. æ”¶å…¥é¢„æµ‹ï¼ˆæœªæ¥3å¹´æ”¶å…¥é¢„ä¼°ï¼‰
  2. æˆæœ¬é¢„ç®—ï¼ˆå›ºå®šæˆæœ¬ã€å˜åŠ¨æˆæœ¬ï¼‰
  3. ç°é‡‘æµåˆ†æï¼ˆæœˆåº¦ç°é‡‘æµè§„åˆ’ï¼‰
  4. ç›ˆäºå¹³è¡¡ç‚¹ï¼ˆä½•æ—¶å®ç°ç›ˆäºå¹³è¡¡ï¼‰
  5. èèµ„éœ€æ±‚ï¼ˆéœ€è¦å¤šå°‘èµ„é‡‘ã€å¦‚ä½•ä½¿ç”¨ï¼‰

åˆ†æè¦æ±‚ï¼š
- æ•°æ®è¦åˆç†å¯ä¿¡
- å‡è®¾è¦æ˜ç¡®è¯´æ˜
- æä¾›ä¹è§‚/ä¸­æ€§/æ‚²è§‚ä¸‰ç§æƒ…æ™¯

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    risk_assessment: `ä½ æ˜¯é£é™©ç®¡ç†ä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€é£é™©è¯„ä¼°ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š800-1000å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. å¸‚åœºé£é™©ï¼ˆå¸‚åœºéœ€æ±‚å˜åŒ–ã€ç«äº‰åŠ å‰§ï¼‰
  2. æŠ€æœ¯é£é™©ï¼ˆæŠ€æœ¯å®ç°éš¾åº¦ã€æ›¿ä»£æŠ€æœ¯ï¼‰
  3. è¿è¥é£é™©ï¼ˆå›¢é˜Ÿã€ä¾›åº”é“¾ã€åˆè§„ï¼‰
  4. è´¢åŠ¡é£é™©ï¼ˆç°é‡‘æµã€èèµ„é£é™©ï¼‰
  5. åº”å¯¹ç­–ç•¥ï¼ˆæ¯ç§é£é™©çš„ç¼“è§£æªæ–½ï¼‰

åˆ†æè¦æ±‚ï¼š
- è¯†åˆ«çœŸå®å­˜åœ¨çš„é£é™©
- ä¸å›é¿é—®é¢˜ï¼Œå®¢è§‚è¯„ä¼°
- æä¾›å¯è¡Œçš„åº”å¯¹æ–¹æ¡ˆ

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    implementation_plan: `ä½ æ˜¯é¡¹ç›®ç®¡ç†ä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€å®æ–½è®¡åˆ’ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š900-1100å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. é‡Œç¨‹ç¢‘è§„åˆ’ï¼ˆ6ä¸ªæœˆã€1å¹´ã€2å¹´ç›®æ ‡ï¼‰
  2. äº§å“å¼€å‘è®¡åˆ’ï¼ˆMVPå¼€å‘ã€è¿­ä»£è®¡åˆ’ï¼‰
  3. å¸‚åœºæ¨å¹¿è®¡åˆ’ï¼ˆå„é˜¶æ®µè¥é”€é‡ç‚¹ï¼‰
  4. å›¢é˜Ÿæ‰©å¼ è®¡åˆ’ï¼ˆäººå‘˜æ‹›è˜æ—¶é—´è¡¨ï¼‰
  5. å…³é”®æŒ‡æ ‡ï¼ˆKPIè®¾å®šã€ç›‘æ§æœºåˆ¶ï¼‰

åˆ†æè¦æ±‚ï¼š
- è®¡åˆ’è¦å…·ä½“å¯æ‰§è¡Œ
- æ—¶é—´èŠ‚ç‚¹è¦åˆç†
- KPIè¦å¯é‡åŒ–

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`,

    appendix: `ä½ æ˜¯å•†ä¸šæ–‡æ¡£æ’°å†™ä¸“å®¶ã€‚åŸºäºç”¨æˆ·åˆ›æ„å¯¹è¯ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦çš„ã€é™„å½•ã€‘ç« èŠ‚ã€‚

è¾“å‡ºè¦æ±‚ï¼š
- å­—æ•°ï¼š600-800å­—
- æ ¼å¼ï¼šMarkdown
- ç»“æ„ï¼š
  1. æœ¯è¯­è¡¨ï¼ˆè¡Œä¸šä¸“ä¸šæœ¯è¯­è§£é‡Šï¼‰
  2. å‚è€ƒèµ„æ–™ï¼ˆæ•°æ®æ¥æºã€ç ”ç©¶æŠ¥å‘Šï¼‰
  3. è¡¥å……ææ–™ï¼ˆäº§å“æˆªå›¾ã€ç”¨æˆ·åé¦ˆï¼‰
  4. è”ç³»æ–¹å¼ï¼ˆå›¢é˜Ÿè”ç³»æ–¹å¼ï¼‰

åˆ†æè¦æ±‚ï¼š
- æœ¯è¯­è§£é‡Šè¦æ¸…æ™°æ˜“æ‡‚
- å‚è€ƒèµ„æ–™è¦å¯ä¿¡
- è¡¥å……ææ–™è¦æœ‰ä»·å€¼

å¯¹è¯å†å²ï¼š
{CONVERSATION}

è¯·ç”Ÿæˆè¯¥ç« èŠ‚å†…å®¹ï¼ˆçº¯Markdownæ ¼å¼ï¼‰ï¼š`
};

// Agentä¿¡æ¯ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰
const CHAPTER_AGENTS = {
    executive_summary: { name: 'ç»¼åˆåˆ†æå¸ˆ', emoji: 'ğŸ¤–', estimatedTime: 30 },
    market_analysis: { name: 'å¸‚åœºåˆ†æå¸ˆ', emoji: 'ğŸ“Š', estimatedTime: 45 },
    solution: { name: 'äº§å“ä¸“å®¶', emoji: 'ğŸ’¡', estimatedTime: 40 },
    business_model: { name: 'å•†ä¸šé¡¾é—®', emoji: 'ğŸ’°', estimatedTime: 35 },
    competitive_landscape: { name: 'ç«äº‰åˆ†æå¸ˆ', emoji: 'âš”ï¸', estimatedTime: 40 },
    marketing_strategy: { name: 'è¥é”€ä¸“å®¶', emoji: 'ğŸ“ˆ', estimatedTime: 35 },
    team_structure: { name: 'ç»„ç»‡é¡¾é—®', emoji: 'ğŸ‘¥', estimatedTime: 30 },
    financial_projection: { name: 'è´¢åŠ¡åˆ†æå¸ˆ', emoji: 'ğŸ’µ', estimatedTime: 50 },
    risk_assessment: { name: 'é£é™©ä¸“å®¶', emoji: 'âš ï¸', estimatedTime: 35 },
    implementation_plan: { name: 'é¡¹ç›®ç»ç†', emoji: 'ğŸ“‹', estimatedTime: 40 },
    appendix: { name: 'æ–‡æ¡£ä¸“å®¶', emoji: 'ğŸ“', estimatedTime: 25 }
};

/**
 * æ ¼å¼åŒ–å¯¹è¯å†å²
 * @param {Array} conversationHistory - å¯¹è¯å†å²æ•°ç»„
 * @returns {String} æ ¼å¼åŒ–åçš„å­—ç¬¦ä¸²
 */
function formatConversation(conversationHistory) {
    return conversationHistory
        .map(msg => `${msg.role === 'user' ? 'ç”¨æˆ·' : 'AIåŠ©æ‰‹'}: ${msg.content}`)
        .join('\n\n');
}

/**
 * ç”Ÿæˆå•ä¸ªç« èŠ‚
 * @param {String} chapterId - ç« èŠ‚ID
 * @param {Array} conversationHistory - å¯¹è¯å†å²
 * @returns {Promise<Object>} { chapterId, content, agent, tokens }
 */
async function generateSingleChapter(chapterId, conversationHistory) {
    const promptTemplate = CHAPTER_PROMPTS[chapterId];
    if (!promptTemplate) {
        throw new Error(`æœªçŸ¥çš„ç« èŠ‚ID: ${chapterId}`);
    }

    const agent = CHAPTER_AGENTS[chapterId];
    const conversation = formatConversation(conversationHistory);
    const prompt = promptTemplate.replace('{CONVERSATION}', conversation);

    // è°ƒç”¨DeepSeek API
    const result = await callDeepSeekAPI(
        [{ role: 'user', content: prompt }],
        null,
        {
            max_tokens: 1500, // ç« èŠ‚å†…å®¹è¾ƒé•¿
            temperature: 0.7
        }
    );

    return {
        chapterId,
        content: result.content,
        agent: agent.name,
        emoji: agent.emoji,
        tokens: result.usage.total_tokens,
        timestamp: Date.now()
    };
}

/**
 * POST /api/business-plan/generate-chapter
 * ç”Ÿæˆå•ä¸ªç« èŠ‚
 */
router.post('/generate-chapter', async (req, res, next) => {
    try {
        const { chapterId, conversationHistory } = req.body;

        // å‚æ•°éªŒè¯
        if (!chapterId) {
            return res.status(400).json({
                code: -1,
                error: 'ç¼ºå°‘å¿…è¦å‚æ•°: chapterId'
            });
        }

        if (!conversationHistory || !Array.isArray(conversationHistory)) {
            return res.status(400).json({
                code: -1,
                error: 'ç¼ºå°‘æˆ–æ— æ•ˆçš„å¯¹è¯å†å²'
            });
        }

        const result = await generateSingleChapter(chapterId, conversationHistory);

        res.json({
            code: 0,
            data: result
        });

    } catch (error) {
        next(error);
    }
});

/**
 * POST /api/business-plan/generate-batch
 * æ‰¹é‡ç”Ÿæˆç« èŠ‚ï¼ˆå¹¶è¡Œï¼‰
 */
router.post('/generate-batch', async (req, res, next) => {
    try {
        const { chapterIds, conversationHistory } = req.body;

        // å‚æ•°éªŒè¯
        if (!chapterIds || !Array.isArray(chapterIds) || chapterIds.length === 0) {
            return res.status(400).json({
                code: -1,
                error: 'ç¼ºå°‘æˆ–æ— æ•ˆçš„ç« èŠ‚IDåˆ—è¡¨'
            });
        }

        if (!conversationHistory || !Array.isArray(conversationHistory)) {
            return res.status(400).json({
                code: -1,
                error: 'ç¼ºå°‘æˆ–æ— æ•ˆçš„å¯¹è¯å†å²'
            });
        }

        // å¹¶è¡Œç”Ÿæˆæ‰€æœ‰ç« èŠ‚
        const startTime = Date.now();
        const promises = chapterIds.map(id => generateSingleChapter(id, conversationHistory));
        const chapters = await Promise.all(promises);
        const duration = ((Date.now() - startTime) / 1000).toFixed(1);

        // è®¡ç®—æ€»tokenä½¿ç”¨é‡
        const totalTokens = chapters.reduce((sum, ch) => sum + ch.tokens, 0);

        // è·å–æˆæœ¬ç»Ÿè®¡
        const costStats = getCostStats();

        res.json({
            code: 0,
            data: {
                chapters,
                totalTokens,
                duration: parseFloat(duration),
                costStats
            }
        });

    } catch (error) {
        next(error);
    }
});

/**
 * GET /api/business-plan/chapters
 * è·å–æ‰€æœ‰å¯ç”¨ç« èŠ‚åˆ—è¡¨
 */
router.get('/chapters', (req, res) => {
    const chapters = Object.keys(CHAPTER_PROMPTS).map(id => ({
        id,
        ...CHAPTER_AGENTS[id]
    }));

    res.json({
        code: 0,
        data: { chapters }
    });
});

/**
 * GET /api/business-plan/cost-stats
 * è·å–æˆæœ¬ç»Ÿè®¡
 */
router.get('/cost-stats', (req, res) => {
    const stats = getCostStats();
    res.json({
        code: 0,
        data: stats
    });
});

export default router;
