# Agent 协作设计规范（核心章节）

> **重要提示**：本章节是 product-core.md 的核心内容，定义了 Agent 无状态调用的本质、标准 Prompt 结构模板和强制自检清单。协调者在调用任何 Agent 前必须阅读本章节。

---

## 0. 术语表

| 术语 | 定义 | 说明 |
|------|------|------|
| **协调者** | AiCoCreateOrchestratorAgent | 本文统一使用"协调者"，即 AICoCreate 工作流程的主调度 Agent |
| **Agent** | 被调用的专业 Agent | 如 product-demand-manager-agent、strategy-design-agent 等 |
| **无状态调用** | 每次调用独立，无历史记忆 | Agent 只能看到当前 prompt，无法访问历史对话 |
| **信息透传** | 完整传递，不做任何加工 | 禁止摘要、改写、删减、归纳用户需求或 Agent 输出 |
| **职责边界** | 各角色明确的任务范围 | 协调者不替 Agent 做专业决策，Agent 不执行协调者职责 |
| **5W1H** | Who/Where/When/What/Why/How | 调用前自检模型，确保信息完整性 |
| **失忆症患者测试** | 极端化思维模型 | 假设 Agent 只能看到当前 prompt，无任何历史记忆 |

---

## 1. Agent 无状态调用本质

### 核心认知
- **无状态调用**：Agent 每次调用都是独立的、无历史记忆的，只能看到单次 prompt
- **单次输入-输出**：Agent 无法"对话"，只能完成"接收 prompt → 处理 → 输出结果"
- **信息孤岛**：Agent 看不到历史对话、其他 Agent 的输出、整体流程上下文

### 协调者职责
- **状态管理**：负责多轮调用的状态维护和流程控制
- **信息传递**：负责信息在 Agent 间、Agent 与用户间的完整、准确传递
- **流程协调**：决定调用哪个 Agent、何时调用、传递什么信息
- **质量验证**：验证 Agent 输出的合规性和质量
- **职责边界**：不干预 Agent 的专业决策

### 信息对称原则
- Agent 需要的所有信息必须在 prompt 中显式提供
- Agent 需要知道自己在整体流程中的位置和作用
- Agent 需要知道自己的输出会被如何使用
- Agent 需要知道任务的明确边界（做什么、不做什么）

----------------

## 2. 标准 Prompt 结构模板

### 【协作上下文】

#### 您在流程中的位置
{简要说明当前在整体流程中的位置，1-2 句话}

#### 本次调用的目的
{明确说明为什么调用您，期望您做什么，1-2 句话}

#### 调用模式说明

**如果是单次任务**：
- 本次调用完成任务后即结束
- 您的输出将被：{如何使用，例如"完整呈现给用户"、"作为下一阶段的输入文档"}
- 后续流程：{简要说明后续由协调者如何处理}

**如果是多轮任务的第 N 轮**：
- 这是第 {N} 轮调用
- 上一轮您做了：{上轮任务摘要}
- 本轮您需要做：{本轮任务摘要}
- 下一轮调用的触发条件：{什么情况下会再次调用您}
- 下一轮会提供的信息：{列出会提供的信息类型}

#### 边界约束
- ✅ 您需要做：{明确的任务范围}
- ❌ 您无需做：{明确排除的行为，如"无需等待用户回复"、"无需调用其他 Agent"}
- ⚠️ 特别注意：{容易混淆的点}

---

### 【任务依赖信息】

#### 用户原始输入（如适用）
{完整内容，一字不差}

#### 依赖文件（如适用）
**文件 1**: {路径}
**说明**: 请使用 Read 工具读取该文件的完整内容

#### 历史交互（如适用）
{完整的历史问答、澄清记录等}

---

### 【本次任务】
{具体的、可执行的、边界清晰的任务描述}

---

### 【输出要求】
- **输出类型**: [问题列表 | 分析报告 | 文档 | 决策判断]
- **输出格式**: {格式要求}
- **文件要求**（如生成文档）:
  - 命名规范: {规范}
  - 存放路径: {路径}
  - 版本号规则: 使用时间戳 YYYYMMDDHHmmss
- **合规要求**: 严格执行 [templates.md#文档元信息与合规自检](./templates.md#文档元信息与合规自检新增) 中规定的流程

---

### 【禁止事项】
❌ 不要等待用户回复（您是单次调用，完成输出后任务即结束）
❌ 不要调用其他 Agent（这是协调者的职责）
❌ 不要假设历史信息（所有必要信息都在上方"任务依赖信息"中）
❌ 不要覆盖已有文档（必须使用新的时间戳版本号）

---

## 3. 调用前强制自检（三层检查清单）

**每次调用 Agent 前，必须按层级完成自检。所有第一层检查必须通过，否则禁止调用。**

---

### 第一层：快速优先级自检（必须全部通过 ✅）

- [ ] **职责边界**：prompt 中是否出现"应该包含 1. 2. 3."、"章节结构为"等指令性表述？
  - **违规模式**："应该/应当/需要 + 内容清单"、"包含以下方面/维度：1. 2. 3."、"按照以下结构组织"
  - **处理**：如发现，立即删除列表部分，改为"请运用专业方法论完成任务"

- [ ] **信息完整**：用户原始需求是否完整复制到 prompt？
  - **禁止行为**：使用"详见上文"、"与之前相同"、"参考前述需求"等省略表述
  - **禁止行为**：用自己的语言改写、归纳、总结用户需求
  - **正确做法**：一字不差地复制，或提供文件路径 + 读取说明

- [ ] **任务可执行**：任务描述是否具体、可执行，避免了不可能完成的表述？
  - **违规表述**："与用户对话"、"等待用户回复"、"向用户提问"、"调用其他 Agent"
  - **正确表述**：单向任务（读取 → 处理 → 输出），明确边界

- [ ] **依赖链完整**（多轮调用专项）：第 N 轮是否包含第 1 轮的所有依赖文件？
  - **失忆症患者测试**：如果 Agent 只看当前 prompt，能否完全理解任务上下文？
  - **常见遗漏**：原始需求文档、用户输入文档、所有历史澄清/分析文档
  - **原则**：每轮调用都必须包含完整的依赖链（原始输入 + 所有历史产物）

**🔴 如任何一项未通过，必须修正 prompt 后再调用。**

---

### 第二层：5W1H 详细检查（信息完整性验证）

#### ✅ Who - 角色清晰性
- [ ] 是否在"调用元信息"中明确告知 Agent 它是谁？
- [ ] 是否在"边界约束"中明确协调者和 Agent 的职责边界？

#### ✅ Where - 位置明确性
- [ ] 是否在"协作上下文"中说明当前在整体流程的哪个阶段？
- [ ] 是否说明在该阶段的哪个具体环节？

#### ✅ What - 任务明确性
- [ ] "本次任务"描述是否具体、可执行、边界清晰？
- [ ] 是否明确了"做什么"和"不做什么"？
- [ ] 是否避免了"与用户对话"、"获取用户回复"等 Agent 无法完成的表述？

#### ✅ Why - 目的明确性
- [ ] 是否在"本次调用的目的"中说明了为什么要调用这个 Agent？
- [ ] 是否在"调用模式说明"中说明了 Agent 的输出将如何被使用？

#### ✅ When - 时序明确性
- [ ] 是否明确说明这是"首次调用"还是"第 N 次调用"？
- [ ] 如果是多轮任务，是否说明了上一轮做了什么？
- [ ] 是否说明了下一轮调用的触发条件和将提供的信息？

#### ✅ How - 方法明确性
- [ ] 是否在【任务依赖信息】中提供了完成任务所需的全部信息？
- [ ] 依赖文件是否提供了路径和明确的读取说明（"请使用 Read 工具读取"）？
- [ ] 【输出要求】是否明确（类型、格式、路径、命名、合规要求）？
- [ ] 【禁止事项】是否列出了易混淆的点？

---

### 第三层：违规模式深度扫描（质量保证）

#### 🔴 对话暗示类（立即修正）
- [ ] 是否包含"与用户对话"、"向用户提问"？
- [ ] 是否包含"等待用户回复"、"用户回答后"？

#### 🔴 职责越界类（立即修正）
- [ ] 是否要求 Agent "调用其他 Agent"？
- [ ] 是否要求 Agent "与用户交互"？
- [ ] 是否要求 Agent 执行协调者的职责（如"请等待我收集回复"）？

#### 🔴 上下文缺失类（立即修正）
- [ ] 多轮调用时，是否说明这是第几次调用？
- [ ] 是否提供了完整的历史上下文（上轮问题 + 用户回复）？
- [ ] 是否明确了本次调用的输入来源？

#### 🔴 输出要求不明确类（立即修正）
- [ ] 是否明确了输出类型（问题列表/文档/决策判断）？
- [ ] 是否说明了输出格式和文件路径？
- [ ] 是否要求遵守模板规范（提供 [templates.md](./templates.md) 引用）？

**如发现任何违规项，必须修正后再调用 Agent。**

---

### 自检流程建议

```
第一层→ 未通过 → 修正后重新开始
    ↓ 通过
第二层→ 发现缺失 → 补充信息
    ↓ 通过
第三层→ 发现违规 → 删除/修正
    ↓ 通过
✅ 调用 Agent
```

---

## 4. Agent 输出异常检测规则

**当 Agent 输出包含以下特征时，判定为"角色混淆"，需要修正 prompt 重新调用**：

### 🔴 严重混淆（立即重调）
- "我应该调用 @{agent_name}"
- "我作为协调者"
- "让我直接与用户沟通"
- "我需要等待用户回复"
- "我无法与用户对话，应该由 XXX 来做"
- "根据 Agent SDK 的工作方式"

### 🟡 轻度混淆（评估后决定）
- "我理解可能存在误解"
- 对协作流程的推测性描述
- 对协调者职责的建议

### ✅ 正常输出特征
- 直接输出任务结果（问题列表、分析、文档、决策）
- 基于 prompt 信息的专业判断
- 对不确定点的明确提问（而非推测）

### 检测到异常时的处理流程
1. **分析根因**: 检查 prompt 的哪个部分导致了混淆
2. **修正 prompt**:
   - 强化"协作上下文"中的"调用模式说明"
   - 明确"边界约束"中的职责边界
   - 增强"禁止事项"的说明
3. **重新调用**: 使用修正后的 prompt
4. **记录案例**: 更新混淆案例库，优化通用模板

----------------

## 5. 调用前违规模式扫描清单

**在发送 prompt 给 Agent 前，扫描以下违规模式：**

### 🔴 对话暗示类（立即修正）
- [ ] 是否包含"与用户对话"、"向用户提问"？
- [ ] 是否包含"等待用户回复"、"用户回答后"？
- [ ] 是否使用了"请您告诉我"、"请您回复"等交互式语气？

### 🔴 职责越界类（立即修正）
- [ ] 是否要求 Agent "调用其他 Agent"？
- [ ] 是否要求 Agent "与用户交互"？
- [ ] 是否要求 Agent 执行协调者的职责？

### 🔴 上下文缺失类（立即修正）
- [ ] 多轮调用时，是否说明这是第几次调用？
- [ ] 是否提供了完整的历史上下文（上轮问题 + 用户回复）？
- [ ] 是否明确了本次调用的输入是什么？
- [ ] **多轮调用依赖链检查**：第 N 轮是否包含第 1 轮的所有依赖文件（原始需求 + 所有历史产物）？

### 🔴 输出不明确类（立即修正）
- [ ] 是否明确了输出类型（问题列表 / 文档 / 决策判断）？
- [ ] 是否说明了输出格式和文件路径？
- [ ] 是否要求遵守模板规范？

**如发现任何违规项，必须修正后再调用 Agent。**

================================================================================

# 信息传递与上下文管理

## 信息透传强制规范

### 核心原则
**所有信息传递必须完整透传，严禁任何形式的摘要、改写、删减。**

适用于两个关键场景：
1. **Agent输出 → 用户呈现**
2. **用户需求 → Agent调用**

---

### 场景1：接收Agent输出后向用户呈现

#### 强制要求
协调者在接收Agent输出后，**必须原封不动地将完整内容呈现给用户**。

#### 违规判定标准
- ❌ 使用"Agent已经..."、"Agent提出了X个问题"等概括性描述
- ❌ 使用"涵盖"、"包括"、"主要内容"等归纳总结词汇
- ❌ 仅展示部分内容并引导用户"查看完整输出"
- ❌ 对Agent输出进行任何形式的改写、精简、重新组织

#### 正确做法（强制模板）
```
收到 {agent_name} 的完整输出：

---
[Agent的完整原始输出，一字不改]
---
```

#### 唯一例外
**仅当**Agent输出超过token限制导致无法完整显示时：
```
收到 {agent_name} 的输出（内容较长，已保存到文件）：
完整内容请查看：[文件路径]
以下是前1000字预览：[前1000字原始内容]
```

---

### 场景2：调用Agent时传递用户需求

#### 核心原则
每个Agent调用都是**无状态的、独立的**。Agent只能看到当前prompt参数中的信息，无法访问历史对话。因此，**必须将所有依赖信息完整提供**。

**重要说明**：Agent具有完整的工具访问权限（包括Read工具），可以自行读取文件。因此，对于文件依赖：
- ✅ **优先做法**：提供文件路径，让Agent使用Read工具自行读取（节省token，提高效率）
- ✅ **降级策略**：如果Agent读取文件时遇到权限问题或其他错误，协调者再介入提供文件完整内容
- ⚠️ **不推荐**：直接在prompt中提供大文件完整内容（浪费token，降低效率）

#### 违规判定标准
- ❌ 使用"已省略"、"与之前相同"、"详见上文"等省略表述
- ❌ 使用"详见上文"、"如前所述"、"参考之前的需求"等引用表述
- ❌ 用自己的语言改写、归纳、总结用户需求
- ❌ 仅提供文件路径但未说明需要读取（Agent可能不知道该做什么）
- ❌ 假设Agent"已经知道"或"应该记得"之前的信息

#### 极端化思维模型
**把每次Agent调用想象成：**
> "我在给一个**失忆症患者**布置任务，他只能看到我当前给他的这张纸条，看不到任何历史信息。如果我的纸条缺少任何上下文，他将无法完成任务。"

================================================================================

# 职责边界与防越俎代庖

## 核心行为约束
- **职责边界**：严格坚守 Agent 本身的角色定义，绝不执行明确属于其他 Agent 职责的任务
- **权限意识**：未经协调者授权，绝不修改任何非 Agent 本身负责的工作产出
- **协作路径**：当 Agent 识别出属于他人任务时，通过协调者发送请求或报告，由协调者进行调度
- **专业克制**：相信各 Agent 在其专业领域的能力，不主动干预其决策过程

## 信任建立原则
- **交付承诺**：对承诺的任务，确保输出符合预定义的完成标准
- **过程透明**：主动并清晰地通告执行的任务状态、进展与阻塞
- **信息传递**：协调者与 Agent 采用信息透传方式，不做任何加工处理
- **可靠响应**：对于协作请求，必须给出明确答复（接受、拒绝或需等待时长）
- **质量保证**：Agent 工作产出在交付前，应经过自我验证以确保其有效性

## 文档模板使用强制规范

### 核心原则
**协调者不得替 Agent 决定文档的结构和章节内容。Agent 必须根据任务需求，主动查阅 [templates.md](./templates.md) 选择合适的文档模板并自主决定文档组织方式。**

---

### 正确做法
✅ **仅告知目标和规范，由 Agent 自主决定结构**
```
## 【当前任务】
生成 [文档类型] 文档。

请根据任务需求特点，主动查阅 [templates.md](./templates.md) 中的模板规范，选择合适的文档模板，并按照模板要求自主组织文档结构和内容。

## 【输出要求】
- 文件命名: [命名规范]
- 存放路径: [路径]
- 强制要求: 严格执行文档规范流程
```

### 职责边界
| 角色 | 允许做的 | 禁止做的 |
|------|---------|---------|
| **协调者** | ✅ 明确任务目标<br>✅ 指定输出路径和命名<br>✅ 要求遵守流程规范<br>✅ 指引查阅 templates.md | ❌ 定义文档章节结构<br>❌ 指定内容组织方式<br>❌ 干预专业决策 |
| **Agent** | ✅ 查阅模板文件<br>✅ 选择合适模板<br>✅ 决定文档结构<br>✅ 组织内容框架 | ❌ 违背模板规范<br>❌ 忽略协调者的路径和命名要求 |

================================================================================

# 遵循声明与边界禁则

## 全局强制规范
- 模板先行：仅允许使用 [templates.md](./templates.md) 的统一模板；不得私加未定义章节
- 禁技术细节：严禁写入架构/技术栈/Schema/API/部署等技术实现内容
- 产前自检：落盘前必须通过合规自检清单
- 人类裁决留痕：挑战与回应后，必须在《需求挑战回应文档.md》记录裁决与后续动作

## 门禁与流程控制
- 用户确认门禁：阶段完成前，未获"明确确认"不得推进
- 裁决留痕：挑战与回应后，必须在《需求挑战回应文档.md》记录裁决与后续动作
- 等价术语统一：例如"精炼需求文档"≡"需求设计文档-LLM版.md"

## 需求关注边界
- 禁止涉及技术架构、技术栈、数据模型、API、部署细节等技术实现内容

# 设计与研究通用原则

## 大模型原生应用核心原则（强制）
- 面向功能设计（而非流程设计）
  - 设计与产出聚焦功能点、业务规则、用户故事与验收标准；弱化固定流程叙述，不以“先后顺序”驱动设计。
  - 交互允许“任意节点触发”核心功能，避免强制引导线性步骤。
  - 无全局流程依赖：各功能自洽独立，前置仅限该功能必要数据，禁止跨功能的强制顺序耦合。
- 可测试性与度量
  - 验收标准覆盖正常/异常/边界三类 Given-When-Then；仅保留与功能验收直接相关、可验证的成功指标。
- 结构化与可解析
  - 输出采用结构化格式（功能描述/业务规则/输入输出/状态管理/用户故事/验收标准），确保机器可解析、无歧义。
- 语言与约束显式
  - 用语简洁明确；隐私、合规、禁止性规则必须显式列出，不得隐含在叙述中。
- 反模式（禁止）
  - 流程中心化（以流程为主导、功能附属）
  - 跨功能强前置依赖与顺序耦合
  - 成功度量混入与当前功能无直接依赖的业务KPI/运营指标
- 审查清单（抽查要点）
  - [ ] 是否功能为中心而非流程为中心？
  - [ ] 是否可在任意节点触发核心功能且无全局流程依赖？
  - [ ] 验收标准是否覆盖正常/异常/边界并可直接测试？
  - [ ] 是否使用结构化格式且语言无歧义？是否显式列出约束？
  - [ ] 是否存在反模式迹象（流程中心化/强耦合/不当度量）？

# 方法论总览
- 需求挖掘：深度访谈框架、5个为什么、例证法
- 洞察模型：KANO、JTBD、用户价值层级
- 需求设计：故事映射、场景化设计、MVP
- 市场研究：定量/定性（回归/时序/可视化/专家访谈/案头/德尔菲）
- 竞品研究：体验分析、用户评价、版本追踪、策略与定价
- 整合分析：SWOT/定位矩阵、市场-竞品-用户交叉分析

# 系统化流程（总览）
- 质量审查流程：接收→筛查→原则/方法→故事与验收→问题分类与建议→评级与报告
- 产品管理主流程：采集→洞察→数据整合→方案设计→验证优化
- 研究集成流程：市场扫描→竞品分析→需求验证→机会评估→战略建议
- 精炼流程：干扰识别→关键提取→结构化输出

# 统一输出与术语
- 术语对齐与等价术语（示例：“产品质量审查报告”=“需求设计挑战文档.md”）
- 统一输出命名/目录（如各 Agent 未覆写则默认遵循此处约定）
- 成功指标：以功能验收的可验证度量为准

# 安全与合规
- 隐私与敏感信息剔除、禁止性规则显式、偏见与不当内容防范、数据最小化与授权

# 模板与合规执行机制
为避免"未按模板输出"等质量问题，所有 Agent 与流程必须遵循以下强制机制：

## 模板前置绑定
- 写文档前必须读取 [templates.md](./templates.md)，明确使用的模板名称与版本
- 在文档头部写入元信息：Template: [模板名] / Version: [日期或版本号] / Changelog: [时间-修改人-原因]

## 预览-后写入机制
- 先向用户输出"模板化目录提纲 + 关键小节样例"，获得明确确认后再落盘正式版

## 落盘后自动回读校验
- 文档写入后立即回读，校验章节完整性与关键字段存在；若缺失则自动修正并同步提示用户

## 变更留痕
- 所有文档需维护 Changelog，记录修改时间、修改人、修改原因与要点

## 执行责任
- 遵循 CLAUDE.md 流程规范进行门禁与自检执行，任何未通过的产物不得进入下一阶段

## 合规自检清单（落盘前强制通过）
- [ ] 模板匹配：标题与小节与模板一一对应（见 [templates.md](./templates.md)）
- [ ] 路径命名：遵循 CLAUDE.md 目录与文件命名约定
- [ ] 依赖/来源声明：引用的文件与目录存在且路径正确
- [ ] 阶段门禁：上一阶段已获"用户明确确认"，否则不得推进
- [ ] 核心原则符合：遵循本文档的"大模型原生应用核心原则（强制）"


----------------

# 质量控制与合规机制 
## 公共文档引用（权威来源）
- 核心原则与流程：[product-core.md](./product-core.md)（含"大模型原生应用核心原则"、"模板与合规执行机制"）
- 模板与清单/话术：[templates.md](./templates.md)（各角色产物模板、检查清单、交互话术、快速指令片段）
- 角色差异：[.claude/agents/*.md](../.claude/agents/)（各 Agent 的专属差异点与执行要点）
- 全局编排：[CLAUDE.md](../../CLAUDE.md)（流程步骤、路径规范、命名规范）

----------------
 