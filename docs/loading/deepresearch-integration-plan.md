# DeepResearché›†æˆå®æ–½è®¡åˆ’ï¼ˆåˆ†é˜¶æ®µï¼‰

> **è¯´æ˜**ï¼šæœ¬è®¡åˆ’åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ
>
> - **ç¬¬ä¸€é˜¶æ®µ**ï¼šåŸºç¡€åŠŸèƒ½å®ç°ï¼ˆUIã€APIã€Pythonå¾®æœåŠ¡ã€é‡è¯•æœºåˆ¶ã€é™çº§ç­–ç•¥ï¼‰
> - **ç¬¬äºŒé˜¶æ®µ**ï¼šåç»­æ‰©å±•å’Œä¼˜åŒ–ï¼ˆè¯¦ç»†æ‰§è¡Œè®¡åˆ’è§æ–‡æ¡£æœ«å°¾ï¼‰

## èƒŒæ™¯ä¸ç›®æ ‡

### éœ€æ±‚èƒŒæ™¯

ç”¨æˆ·å¸Œæœ›åœ¨ThinkCraftçš„å•†ä¸šè®¡åˆ’ä¹¦å’Œäº§å“ç«‹é¡¹ææ–™ç”ŸæˆåŠŸèƒ½ä¸­é›†æˆAlibaba-NLP/DeepResearchï¼Œä»¥æå‡æŠ¥å‘Šçš„ä¸“ä¸šæ€§å’Œæ·±åº¦ã€‚å½“å‰ç³»ç»Ÿä½¿ç”¨DeepSeek APIè¿›è¡Œå¿«é€Ÿç”Ÿæˆï¼Œä½†ç¼ºä¹æ·±åº¦ç ”ç©¶èƒ½åŠ›ï¼ˆå¤šè½®è¿­ä»£ã€ç½‘ç»œæœç´¢ã€æ•°æ®éªŒè¯ï¼‰ã€‚

### æ ¸å¿ƒéœ€æ±‚

1. **åœ¨ç« èŠ‚é€‰æ‹©å¼¹çª—ä¸­æ·»åŠ æ·±åº¦ç ”ç©¶å¼€å…³**ï¼šé’ˆå¯¹å½“å‰å¯¹è¯ï¼ˆchatIDï¼‰å’Œæ–‡æ¡£ç±»å‹ï¼ˆå•†ä¸šè®¡åˆ’ä¹¦/äº§å“ç«‹é¡¹ææ–™ï¼‰çš„è®¾ç½®ï¼Œä¸åŒchatIDä¹‹é—´ç›¸äº’éš”ç¦»
2. **å¼€å…³ä½œç”¨èŒƒå›´**ï¼šæ•´ç¯‡æ–‡æ¡£ï¼Œä¸åŒºåˆ†ç« èŠ‚
   - **å¼€å¯æ—¶**ï¼šæ‰€æœ‰é€‰ä¸­çš„ç« èŠ‚éƒ½ä½¿ç”¨DeepResearchæ·±åº¦ç ”ç©¶æ¨¡å¼ç”Ÿæˆ
   - **æœªå¼€å¯æ—¶**ï¼šæ‰€æœ‰ç« èŠ‚éƒ½ä½¿ç”¨ç°æœ‰çš„DeepSeekå¿«é€Ÿç”Ÿæˆé€»è¾‘
3. **é™çº§ç­–ç•¥**ï¼šDeepResearchæœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œ**ä¸»åŠ¨è¯¢é—®ç”¨æˆ·**æ˜¯å¦é™çº§åˆ°DeepSeekï¼Œè€Œä¸æ˜¯è‡ªåŠ¨é™çº§
4. **è¶…æ—¶å’Œé‡è¯•æœºåˆ¶**ï¼š
   - è¶…æ—¶æ—¶é—´å°½å¯èƒ½æ”¾å¤§ï¼ˆå»ºè®®10åˆ†é’Ÿ/ç« èŠ‚ï¼‰ï¼Œé¿å…æ­£å¸¸ç”Ÿæˆè¢«è¯¯åˆ¤ä¸ºè¶…æ—¶
   - è¯†åˆ«æœåŠ¡å¼‚å¸¸ï¼ˆè¿æ¥å¤±è´¥ã€500é”™è¯¯ç­‰ï¼‰ï¼Œé‡‡ç”¨5æ¬¡é‡è¯•æœºåˆ¶
   - 5æ¬¡é‡è¯•ä»å¤±è´¥åï¼Œå‘ŠçŸ¥ç”¨æˆ·å¹¶æ”¯æŒç”¨æˆ·æ‰‹åŠ¨é‡è¯•
5. **æ”¯æŒèŒƒå›´**ï¼šæ‰€æœ‰ç« èŠ‚éƒ½æ”¯æŒæ·±åº¦ç ”ç©¶ï¼ˆä¸åŒºåˆ†ç« èŠ‚ç±»å‹ï¼‰

### æŠ€æœ¯æ–¹æ¡ˆ

- **å‰ç«¯**ï¼šåœ¨ç« èŠ‚é€‰æ‹©å¼¹çª—æ·»åŠ å¼€å…³ï¼ŒçŠ¶æ€ä¸chatID+æ–‡æ¡£ç±»å‹å…³è”å­˜å‚¨
- **åç«¯**ï¼šPythonå¾®æœåŠ¡é›†æˆDeepResearchï¼ŒNode.jsåç«¯é€šè¿‡HTTPè°ƒç”¨
- **æ•°æ®éš”ç¦»**ï¼šæ¯ä¸ªchatIDçš„æ¯ç§æ–‡æ¡£ç±»å‹ç‹¬ç«‹çš„æ·±åº¦ç ”ç©¶è®¾ç½®
- **ç”Ÿæˆé€»è¾‘**ï¼šå¼€å…³å¼€å¯åï¼Œæ‰€æœ‰ç« èŠ‚ç»Ÿä¸€ä½¿ç”¨æ·±åº¦ç ”ç©¶æ¨¡å¼ï¼Œä¸éœ€è¦å•ç‹¬åˆ¤æ–­ç« èŠ‚ç±»å‹
- **è¶…æ—¶é…ç½®**ï¼šå•ç« èŠ‚è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º10åˆ†é’Ÿï¼Œé¿å…è¯¯åˆ¤
- **é‡è¯•æœºåˆ¶**ï¼šæœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¯•5æ¬¡ï¼Œå¤±è´¥åæç¤ºç”¨æˆ·å¹¶æ”¯æŒæ‰‹åŠ¨é‡è¯•
- **é™çº§ç­–ç•¥**ï¼šæœåŠ¡ä¸å¯ç”¨æ—¶è¯¢é—®ç”¨æˆ·æ˜¯å¦é™çº§ï¼Œä¸è‡ªåŠ¨é™çº§

---

## å½“å‰ç³»ç»Ÿåˆ†æ

### ç« èŠ‚ç”Ÿæˆæµç¨‹

1. **å‰ç«¯è§¦å‘**ï¼šç”¨æˆ·ç‚¹å‡»"ç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦/äº§å“ç«‹é¡¹ææ–™"æŒ‰é’®
2. **ç« èŠ‚é€‰æ‹©**ï¼šæ˜¾ç¤ºç« èŠ‚é€‰æ‹©å¼¹çª—ï¼ˆ`showChapterSelection`ï¼‰
   - æ ¸å¿ƒç« èŠ‚ï¼ˆå¿…é€‰ï¼‰ï¼šæ‰§è¡Œæ‘˜è¦ã€å¸‚åœºåˆ†æã€è§£å†³æ–¹æ¡ˆã€å•†ä¸šæ¨¡å¼
   - å¯é€‰ç« èŠ‚ï¼šç«äº‰æ ¼å±€ã€è¥é”€ç­–ç•¥ã€å›¢é˜Ÿæ¶æ„ã€è´¢åŠ¡é¢„æµ‹ç­‰
3. **å¼€å§‹ç”Ÿæˆ**ï¼šç”¨æˆ·ç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"ï¼ˆ`startGeneration`ï¼‰
   - è·å–é€‰ä¸­çš„ç« èŠ‚IDåˆ—è¡¨
   - è°ƒç”¨`generate(type, chapterIds)`æ–¹æ³•
4. **é€ç« èŠ‚ç”Ÿæˆ**ï¼šå¾ªç¯è°ƒç”¨åç«¯API `/api/business-plan/generate-chapter`
   - ä¼ é€’ï¼š`chapterId`, `conversationHistory`, `type`
   - è¿”å›ï¼šç« èŠ‚å†…å®¹ã€tokensã€agentä¿¡æ¯
5. **è¿›åº¦å±•ç¤º**ï¼šå®æ—¶æ›´æ–°è¿›åº¦å¼¹çª—ï¼Œæ˜¾ç¤ºå½“å‰ç”Ÿæˆçš„ç« èŠ‚å’Œagent
6. **å®Œæˆä¿å­˜**ï¼šæ‰€æœ‰ç« èŠ‚ç”Ÿæˆå®Œæˆåï¼Œä¿å­˜åˆ°IndexedDBå¹¶æ˜¾ç¤ºæŠ¥å‘Š

### å…³é”®æ–‡ä»¶

- **å‰ç«¯**ï¼š
  - `/frontend/js/modules/business-plan-generator.js` - ç« èŠ‚é€‰æ‹©å’Œç”Ÿæˆé€»è¾‘
  - `/index.html` - ç« èŠ‚é€‰æ‹©å¼¹çª—HTMLç»“æ„ï¼ˆç¬¬602-628è¡Œï¼‰
  - `/frontend/js/utils/global-bridges.js` - å…¨å±€å‡½æ•°æ¡¥æ¥

- **åç«¯**ï¼š
  - `/backend/src/features/business-plan/interfaces/business-plan-routes.js` - APIè·¯ç”±
  - `/backend/src/infrastructure/ai/deepseek-client.js` - DeepSeek APIå®¢æˆ·ç«¯
  - `/backend/src/utils/prompt-loader.js` - æç¤ºè¯åŠ è½½å™¨

### æ•°æ®éš”ç¦»æœºåˆ¶

- å½“å‰ç³»ç»Ÿå·²å®ç°chatIDçº§åˆ«çš„æ•°æ®éš”ç¦»
- ç”ŸæˆçŠ¶æ€å­˜å‚¨åœ¨`StateManager`ä¸­ï¼ŒæŒ‰chatIDç´¢å¼•
- IndexedDBæŒä¹…åŒ–ä¹ŸæŒ‰chatIDå­˜å‚¨

---

## å®æ–½æ–¹æ¡ˆ

### é˜¶æ®µä¸€ï¼šå‰ç«¯UIå’ŒçŠ¶æ€ç®¡ç†ï¼ˆP0ï¼‰

#### 1.1 ä¿®æ”¹ç« èŠ‚é€‰æ‹©å¼¹çª—HTML

**æ–‡ä»¶**ï¼š`/index.html`ï¼ˆç¬¬602-628è¡Œï¼‰

åœ¨`<div class="modal-body">`ä¸­æ·»åŠ æ·±åº¦ç ”ç©¶å¼€å…³ï¼š

```html
<div class="modal-body">
  <p class="tip">æ ¸å¿ƒç« èŠ‚å°†è‡ªåŠ¨ç”Ÿæˆï¼Œæ‚¨å¯ä»¥é€‰æ‹©éœ€è¦æ·±å…¥åˆ†æçš„å…¶ä»–ç« èŠ‚</p>

  <!-- æ–°å¢ï¼šæ·±åº¦ç ”ç©¶å¼€å…³ -->
  <div
    class="deep-research-toggle"
    style="margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 8px;"
  >
    <label style="display: flex; align-items: center; cursor: pointer;">
      <input type="checkbox" id="deepResearchSwitch" style="margin-right: 8px;" />
      <div>
        <strong>å¯ç”¨æ·±åº¦ç ”ç©¶æ¨¡å¼ï¼ˆæ•´ç¯‡æ–‡æ¡£ï¼‰</strong>
        <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);">
          ä½¿ç”¨DeepResearchå¯¹æ‰€æœ‰ç« èŠ‚è¿›è¡Œå¤šè½®è¿­ä»£å’Œç½‘ç»œæœç´¢ï¼Œç”Ÿæˆæ›´ä¸“ä¸šçš„æŠ¥å‘Šï¼ˆè€—æ—¶çº¦2-3åˆ†é’Ÿ/ç« èŠ‚ï¼‰
        </p>
      </div>
    </label>
  </div>

  <div id="chapterList">
    <!-- ç« èŠ‚åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
  </div>
</div>
```

#### 1.2 ä¿®æ”¹å‰ç«¯ç”Ÿæˆé€»è¾‘

**æ–‡ä»¶**ï¼š`/frontend/js/modules/business-plan-generator.js`

**ä¿®æ”¹`startGeneration()`æ–¹æ³•**ï¼ˆç¬¬648-677è¡Œï¼‰ï¼š

```javascript
async startGeneration() {
    // è·å–é€‰ä¸­çš„ç« èŠ‚
    const checkboxes = document.querySelectorAll('#chapterList input[type="checkbox"]:checked');
    let selectedChapters = Array.from(checkboxes).map(cb => cb.dataset.chapter);

    if (selectedChapters.length === 0) {
        window.modalManager.alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç« èŠ‚', 'warning');
        return;
    }

    // æ–°å¢ï¼šè·å–æ·±åº¦ç ”ç©¶å¼€å…³çŠ¶æ€
    const deepResearchSwitch = document.getElementById('deepResearchSwitch');
    const useDeepResearch = deepResearchSwitch ? deepResearchSwitch.checked : false;

    // å…³é—­é€‰æ‹©æ¨¡æ€æ¡†
    window.modalManager.close('chapterSelectionModal');

    // è·å–å½“å‰æŠ¥å‘Šç±»å‹
    const modal = document.getElementById('chapterSelectionModal');
    const type = modal?.dataset?.reportType || 'business';

    // éªŒè¯typeå‚æ•°
    if (type !== 'business' && type !== 'proposal') {
        console.error('[å¼€å§‹ç”Ÿæˆ] æ— æ•ˆçš„æŠ¥å‘Šç±»å‹', { type, typeOf: typeof type });
        alert('ç³»ç»Ÿé”™è¯¯ï¼šæ— æ•ˆçš„æŠ¥å‘Šç±»å‹');
        return;
    }

    selectedChapters = this.normalizeChapterIdsByType(type, selectedChapters);
    logger.debug('[å¼€å§‹ç”Ÿæˆ] æŠ¥å‘Šç±»å‹:', type, 'é€‰ä¸­ç« èŠ‚:', selectedChapters, 'æ·±åº¦ç ”ç©¶:', useDeepResearch);

    // å¼€å§‹ç”Ÿæˆæµç¨‹ï¼ˆä¼ é€’æ·±åº¦ç ”ç©¶æ ‡å¿—ï¼‰
    await this.generate(type, selectedChapters, useDeepResearch);
}
```

**ä¿®æ”¹`generate()`æ–¹æ³•ç­¾å**ï¼ˆç¬¬684è¡Œï¼‰ï¼š

```javascript
async generate(type, chapterIds, useDeepResearch = false) {
    const chatId = window.state?.currentChat || null;

    try {
        // ... ç°æœ‰çš„å‚æ•°éªŒè¯ä»£ç  ...

        logger.debug('[ç”Ÿæˆ] å¼€å§‹ç”Ÿæˆ:', {
            type,
            chapterIds,
            chatId,
            useDeepResearch  // æ–°å¢æ—¥å¿—
        });

        // ... ç°æœ‰çš„çŠ¶æ€ç®¡ç†ä»£ç  ...

        // æŒä¹…åŒ–æ—¶ä¿å­˜æ·±åº¦ç ”ç©¶æ ‡å¿—
        await this.persistGenerationState(chatId, type, {
            status: 'generating',
            selectedChapters: chapterIds,
            useDeepResearch,  // æ–°å¢ï¼šä¿å­˜æ·±åº¦ç ”ç©¶æ ‡å¿—
            progress: { /* ... */ },
            // ... å…¶ä»–å­—æ®µ ...
        });

        // ... å¾ªç¯ç”Ÿæˆç« èŠ‚çš„ä»£ç  ...

        // åœ¨ç« èŠ‚ç”Ÿæˆå¤±è´¥æ—¶ï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºDeepResearché”™è¯¯
        // å¦‚æœæ˜¯ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦é™çº§åˆ°DeepSeek
        if (useDeepResearch && error.message.includes('DeepResearch')) {
            const shouldFallback = confirm(
                'DeepResearchæœåŠ¡è°ƒç”¨å¤±è´¥ã€‚\n\n' +
                'é”™è¯¯ä¿¡æ¯ï¼š' + error.message + '\n\n' +
                'æ˜¯å¦é™çº§åˆ°DeepSeekå¿«é€Ÿæ¨¡å¼ç»§ç»­ç”Ÿæˆï¼Ÿ\n\n' +
                'ç‚¹å‡»"ç¡®å®š"é™çº§ï¼Œç‚¹å‡»"å–æ¶ˆ"åœæ­¢ç”Ÿæˆ'
            );

            if (shouldFallback) {
                // ç”¨æˆ·åŒæ„é™çº§ï¼Œé‡æ–°è°ƒç”¨APIï¼ˆä¸ä½¿ç”¨æ·±åº¦ç ”ç©¶ï¼‰
                console.log('[ç”Ÿæˆ] ç”¨æˆ·åŒæ„é™çº§åˆ°DeepSeek');
                // é‡æ–°è°ƒç”¨å½“å‰ç« èŠ‚çš„ç”Ÿæˆï¼ŒuseDeepResearchè®¾ä¸ºfalse
                // ... å®ç°é™çº§é€»è¾‘ ...
            } else {
                // ç”¨æˆ·æ‹’ç»é™çº§ï¼Œåœæ­¢ç”Ÿæˆ
                console.log('[ç”Ÿæˆ] ç”¨æˆ·æ‹’ç»é™çº§ï¼Œåœæ­¢ç”Ÿæˆ');
                throw error;
            }
        }

        // ... ç»§ç»­ç°æœ‰é€»è¾‘ ...
    }
}
```

**ä¿®æ”¹ç« èŠ‚ç”ŸæˆAPIè°ƒç”¨**ï¼ˆç¬¬858-867è¡Œé™„è¿‘ï¼‰ï¼š

```javascript
// åœ¨å¾ªç¯ç”Ÿæˆç« èŠ‚æ—¶ï¼Œä¼ é€’æ·±åº¦ç ”ç©¶æ ‡å¿—
// æ³¨æ„ï¼šuseDeepResearchå¯¹æ‰€æœ‰ç« èŠ‚ç”Ÿæ•ˆï¼Œä¸éœ€è¦å•ç‹¬åˆ¤æ–­ç« èŠ‚ç±»å‹
const response = await this.api.request('/api/business-plan/generate-chapter', {
  method: 'POST',
  body: {
    chapterId,
    conversationHistory: conversation,
    type,
    useDeepResearch // æ–°å¢ï¼šä¼ é€’æ·±åº¦ç ”ç©¶æ ‡å¿—ï¼ˆå¯¹æ‰€æœ‰ç« èŠ‚ç”Ÿæ•ˆï¼‰
  },
  timeout: useDeepResearch ? 600000 : 180000, // æ·±åº¦ç ”ç©¶æ¨¡å¼è¶…æ—¶10åˆ†é’Ÿï¼Œé¿å…è¯¯åˆ¤
  retry: 0 // ä¸åœ¨å‰ç«¯é‡è¯•ï¼Œç”±åç«¯ç»Ÿä¸€å¤„ç†é‡è¯•é€»è¾‘
});
```

---

### é˜¶æ®µäºŒï¼šåç«¯APIæ‰©å±•ï¼ˆP0ï¼‰

#### 2.1 ä¿®æ”¹åç«¯è·¯ç”±

**æ–‡ä»¶**ï¼š`/backend/src/features/business-plan/interfaces/business-plan-routes.js`ï¼ˆç¬¬167-196è¡Œï¼‰

```javascript
router.post('/generate-chapter', async (req, res, next) => {
  try {
    const {
      chapterId,
      conversationHistory,
      type = 'business',
      useDeepResearch = false // æ–°å¢ï¼šæ·±åº¦ç ”ç©¶æ ‡å¿—
    } = req.body;

    // å‚æ•°éªŒè¯
    if (!chapterId) {
      return res.status(400).json({
        code: -1,
        error: 'ç¼ºå°‘å¿…è¦å‚æ•°: chapterId'
      });
    }

    if (!conversationHistory || !Array.isArray(conversationHistory)) {
      return res.status(400).json({
        code: -1,
        error: 'ç¼ºå°‘æˆ–æ— æ•ˆçš„å¯¹è¯å†å²'
      });
    }

    // æ ¹æ®æ·±åº¦ç ”ç©¶æ ‡å¿—é€‰æ‹©ç”Ÿæˆæ–¹å¼
    const result = await generateSingleChapter(
      chapterId,
      conversationHistory,
      type,
      useDeepResearch // æ–°å¢ï¼šä¼ é€’æ·±åº¦ç ”ç©¶æ ‡å¿—
    );

    res.json({
      code: 0,
      data: result
    });
  } catch (error) {
    next(error);
  }
});
```

#### 2.2 ä¿®æ”¹ç« èŠ‚ç”Ÿæˆå‡½æ•°

**æ–‡ä»¶**ï¼š`/backend/src/features/business-plan/interfaces/business-plan-routes.js`ï¼ˆç¬¬75-161è¡Œï¼‰

```javascript
async function generateSingleChapter(
  chapterId,
  conversationHistory,
  type = 'business',
  useDeepResearch = false
) {
  // å¦‚æœå¯ç”¨æ·±åº¦ç ”ç©¶ï¼Œè°ƒç”¨DeepResearchæœåŠ¡
  if (useDeepResearch) {
    return await generateWithDeepResearch(chapterId, conversationHistory, type);
  }

  // å¦åˆ™ä½¿ç”¨ç°æœ‰çš„DeepSeeké€»è¾‘
  return await generateWithDeepSeek(chapterId, conversationHistory, type);
}

// å°†ç°æœ‰çš„ç”Ÿæˆé€»è¾‘é‡æ„ä¸ºç‹¬ç«‹å‡½æ•°
async function generateWithDeepSeek(chapterId, conversationHistory, type) {
  // ... ç°æœ‰çš„DeepSeekç”Ÿæˆé€»è¾‘ï¼ˆç¬¬75-161è¡Œçš„ä»£ç ï¼‰...
  const prompts = type === 'proposal' ? PROPOSAL_PROMPTS : CHAPTER_PROMPTS;
  let promptTemplate = prompts[chapterId];

  if (!promptTemplate) {
    const docType = type === 'proposal' ? 'proposal' : 'business-plan';
    promptTemplate = await promptLoader.loadChapterTemplate(docType, chapterId);
  }

  const agent = CHAPTER_AGENTS[chapterId];
  const conversation = formatConversation(conversationHistory);

  let prompt;
  if (promptTemplate.includes('{CONVERSATION}')) {
    prompt = promptTemplate.replace('{CONVERSATION}', conversation);
  } else {
    prompt = `${promptTemplate}\n\n**å¯¹è¯å†å²**ï¼š\n\`\`\`\n${conversation}\n\`\`\``;
  }

  const result = await callDeepSeekAPI([{ role: 'user', content: prompt }], null, {
    max_tokens: 1500,
    temperature: 0.7,
    timeout: 120000
  });

  return {
    chapterId,
    content: result.content,
    agent: agent.name,
    emoji: agent.emoji,
    tokens: result.usage.total_tokens,
    timestamp: Date.now(),
    mode: 'fast' // æ ‡è®°ç”Ÿæˆæ¨¡å¼
  };
}

// æ–°å¢ï¼šDeepResearchç”Ÿæˆå‡½æ•°ï¼ˆå ä½ç¬¦ï¼Œé˜¶æ®µä¸‰å®ç°ï¼‰
async function generateWithDeepResearch(chapterId, conversationHistory, type) {
  // é˜¶æ®µä¸‰æ¥å…¥ï¼šè°ƒç”¨ Python å¾®æœåŠ¡
  // æš‚æ—¶è¿”å›æ¨¡æ‹Ÿæ•°æ®æˆ–æŠ›å‡ºé”™è¯¯
  throw new Error('DeepResearchæœåŠ¡å°šæœªå®ç°ï¼Œè¯·å…ˆéƒ¨ç½²Pythonå¾®æœåŠ¡');
}
```

---

### é˜¶æ®µä¸‰ï¼šPythonå¾®æœåŠ¡å¼€å‘ï¼ˆP1ï¼‰

#### 3.1 åˆ›å»ºPythonå¾®æœåŠ¡ç›®å½•ç»“æ„

```
/backend/services/deep-research/
â”œâ”€â”€ app.py                 # Flask/FastAPIä¸»åº”ç”¨
â”œâ”€â”€ requirements.txt       # Pythonä¾èµ–
â”œâ”€â”€ config.py             # é…ç½®æ–‡ä»¶
â”œâ”€â”€ deep_research_client.py  # DeepResearchå®¢æˆ·ç«¯å°è£…
â”œâ”€â”€ Dockerfile            # Dockeré…ç½®ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ README.md             # æœåŠ¡æ–‡æ¡£
```

#### 3.2 å®‰è£…ä¾èµ–

**æ–‡ä»¶**ï¼š`/backend/services/deep-research/requirements.txt`

```txt
flask==3.0.0
deep-research==0.1.0  # éœ€è¦éªŒè¯å®é™…åŒ…å
requests==2.31.0
python-dotenv==1.0.0
```

#### 3.3 å®ç°FlaskæœåŠ¡

**æ–‡ä»¶**ï¼š`/backend/services/deep-research/app.py`

```python
from flask import Flask, request, jsonify
from deep_research_client import DeepResearchClient
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)
client = DeepResearchClient(api_key=os.getenv('DEEPRESEARCH_API_KEY'))

@app.route('/health', methods=['GET'])
def health_check():
    return jsonify({'status': 'ok', 'service': 'deep-research'})

@app.route('/research/business-plan-chapter', methods=['POST'])
def research_chapter():
    try:
        data = request.json
        chapter_id = data.get('chapterId')
        conversation_history = data.get('conversationHistory')
        doc_type = data.get('type', 'business')

        if not chapter_id or not conversation_history:
            return jsonify({'error': 'ç¼ºå°‘å¿…è¦å‚æ•°'}), 400

        # è°ƒç”¨DeepResearch
        result = client.generate_chapter(
            chapter_id=chapter_id,
            conversation_history=conversation_history,
            doc_type=doc_type,
            depth='medium',
            iterations=3
        )

        return jsonify({
            'chapterId': chapter_id,
            'content': result['content'],
            'sources': result.get('sources', []),
            'confidence': result.get('confidence', 0.8),
            'tokens': result.get('tokens', 0),
            'mode': 'deep'
        })

    except Exception as e:
        return jsonify({'error': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5001, debug=False)
```

#### 3.4 å®ç°DeepResearchå®¢æˆ·ç«¯

**æ–‡ä»¶**ï¼š`/backend/services/deep-research/deep_research_client.py`

```python
from deep_research import DeepResearch  # éœ€è¦éªŒè¯å®é™…å¯¼å…¥æ–¹å¼

class DeepResearchClient:
    def __init__(self, api_key):
        self.client = DeepResearch(api_key=api_key)

    def generate_chapter(self, chapter_id, conversation_history, doc_type, depth='medium', iterations=3):
        """
        ç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦ç« èŠ‚
        """
        # æ„å»ºç ”ç©¶æŸ¥è¯¢
        query = self._build_research_query(chapter_id, conversation_history, doc_type)

        # è°ƒç”¨DeepResearch API
        result = self.client.research(
            query=query,
            depth=depth,
            sources=['web', 'academic'],
            iterations=iterations,
            output_format='markdown'
        )

        return {
            'content': result.content,
            'sources': result.sources,
            'confidence': result.confidence,
            'tokens': result.usage.total_tokens
        }

    def _build_research_query(self, chapter_id, conversation_history, doc_type):
        """
        æ ¹æ®ç« èŠ‚IDæ„å»ºç ”ç©¶æŸ¥è¯¢
        """
        # æ ¼å¼åŒ–å¯¹è¯å†å²
        conversation_text = self._format_conversation(conversation_history)

        # ç« èŠ‚ç‰¹å®šçš„æŸ¥è¯¢æ¨¡æ¿
        queries = {
            'market-analysis': f"""
åŸºäºä»¥ä¸‹äº§å“åˆ›æ„ï¼Œè¿›è¡Œæ·±åº¦å¸‚åœºåˆ†æï¼š
1. ç›®æ ‡å¸‚åœºè§„æ¨¡ï¼ˆTAM/SAM/SOMï¼‰å’Œå¢é•¿è¶‹åŠ¿
2. ç”¨æˆ·ç”»åƒã€éœ€æ±‚ç—›ç‚¹å’Œè¡Œä¸ºç‰¹å¾
3. å¸‚åœºé©±åŠ¨å› ç´ å’Œå‘å±•æœºä¼š
4. è¡Œä¸šæ ‡å‡†å’Œæœ€ä½³å®è·µ

äº§å“åˆ›æ„ï¼š
{conversation_text}

è¯·æä¾›æ•°æ®æ”¯æŒå’Œå¯é æ¥æºã€‚
""",
            'competitive-landscape': f"""
åˆ†æä»¥ä¸‹äº§å“çš„ç«äº‰æ ¼å±€ï¼š
1. ä¸»è¦ç«å“åˆ—è¡¨å’Œæ ¸å¿ƒç‰¹ç‚¹
2. ç«äº‰ä¼˜åŠ¿å¯¹æ¯”çŸ©é˜µ
3. å¸‚åœºå®šä½å’Œå·®å¼‚åŒ–ç­–ç•¥
4. ç«äº‰å£å’å’ŒæŠ¤åŸæ²³

äº§å“åˆ›æ„ï¼š
{conversation_text}

è¯·æä¾›å…·ä½“çš„ç«å“æ•°æ®å’Œå¸‚åœºä»½é¢ä¿¡æ¯ã€‚
""",
            'financial-projection': f"""
åŸºäºä»¥ä¸‹äº§å“åˆ›æ„ï¼Œè¿›è¡Œè´¢åŠ¡é¢„æµ‹åˆ†æï¼š
1. æ”¶å…¥æ¨¡å‹å’Œå®šä»·ç­–ç•¥
2. æˆæœ¬ç»“æ„å’Œç›ˆäºå¹³è¡¡ç‚¹
3. 3-5å¹´è´¢åŠ¡é¢„æµ‹
4. è¡Œä¸šè´¢åŠ¡åŸºå‡†å’Œä¼°å€¼å‚è€ƒ

äº§å“åˆ›æ„ï¼š
{conversation_text}

è¯·æä¾›è¡Œä¸šæ•°æ®å’Œè´¢åŠ¡æ¨¡å‹å‚è€ƒã€‚
"""
        }

        # è¿”å›å¯¹åº”ç« èŠ‚çš„æŸ¥è¯¢ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›é€šç”¨æŸ¥è¯¢
        return queries.get(chapter_id, f"åŸºäºä»¥ä¸‹å†…å®¹ç”Ÿæˆ{chapter_id}ç« èŠ‚ï¼š\n{conversation_text}")

    def _format_conversation(self, conversation_history):
        """
        æ ¼å¼åŒ–å¯¹è¯å†å²ä¸ºæ–‡æœ¬
        """
        if isinstance(conversation_history, list):
            return '\n'.join([
                f"{msg.get('role', 'user')}: {msg.get('content', '')}"
                for msg in conversation_history
            ])
        return str(conversation_history)
```

---

### é˜¶æ®µå››ï¼šNode.jsåç«¯é›†æˆPythonæœåŠ¡ï¼ˆP1ï¼‰

#### 4.1 åˆ›å»ºDeepResearch HTTPå®¢æˆ·ç«¯

**æ–‡ä»¶**ï¼š`/backend/src/infrastructure/ai/deep-research-http-client.js`ï¼ˆæ–°å»ºï¼‰

```javascript
import axios from 'axios';

const DEEPRESEARCH_SERVICE_URL = process.env.DEEPRESEARCH_SERVICE_URL || 'http://localhost:5001';
const REQUEST_TIMEOUT = 600000; // 10åˆ†é’Ÿè¶…æ—¶ï¼Œé¿å…è¯¯åˆ¤
const MAX_RETRIES = 5; // æœ€å¤§é‡è¯•æ¬¡æ•°

/**
 * è°ƒç”¨DeepResearch Pythonå¾®æœåŠ¡ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
 */
export async function callDeepResearchService(chapterId, conversationHistory, type = 'business') {
  let lastError = null;

  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
    try {
      console.log(`[DeepResearch] ç¬¬${attempt}æ¬¡å°è¯•è°ƒç”¨æœåŠ¡...`);

      const response = await axios.post(
        `${DEEPRESEARCH_SERVICE_URL}/research/business-plan-chapter`,
        {
          chapterId,
          conversationHistory,
          type
        },
        {
          timeout: REQUEST_TIMEOUT,
          headers: {
            'Content-Type': 'application/json'
          }
        }
      );

      console.log(`[DeepResearch] ç¬¬${attempt}æ¬¡è°ƒç”¨æˆåŠŸ`);
      return response.data;
    } catch (error) {
      lastError = error;
      console.error(`[DeepResearch] ç¬¬${attempt}æ¬¡è°ƒç”¨å¤±è´¥:`, error.message);

      // åˆ¤æ–­æ˜¯å¦ä¸ºæœåŠ¡å¼‚å¸¸ï¼ˆéœ€è¦é‡è¯•ï¼‰
      const isServiceError =
        error.code === 'ECONNREFUSED' || // è¿æ¥è¢«æ‹’ç»
        error.code === 'ETIMEDOUT' || // è¿æ¥è¶…æ—¶
        error.code === 'ENOTFOUND' || // åŸŸåè§£æå¤±è´¥
        (error.response && error.response.status >= 500); // æœåŠ¡å™¨é”™è¯¯

      // å¦‚æœæ˜¯è¶…æ—¶é”™è¯¯ï¼ˆECONNABORTEDï¼‰ï¼Œä¸é‡è¯•ï¼Œç›´æ¥æŠ›å‡º
      if (error.code === 'ECONNABORTED') {
        throw new Error('DeepResearchç”Ÿæˆè¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€æˆ–ç¨åé‡è¯•');
      }

      // å¦‚æœä¸æ˜¯æœåŠ¡å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡ºé”™è¯¯
      if (!isServiceError) {
        if (error.response) {
          throw new Error(`DeepResearchæœåŠ¡é”™è¯¯: ${error.response.data.error || error.message}`);
        } else {
          throw new Error(`DeepResearchè°ƒç”¨å¤±è´¥: ${error.message}`);
        }
      }

      // å¦‚æœæ˜¯æœ€åä¸€æ¬¡é‡è¯•ï¼ŒæŠ›å‡ºé”™è¯¯
      if (attempt === MAX_RETRIES) {
        throw new Error(`DeepResearchæœåŠ¡å¼‚å¸¸ï¼Œå·²é‡è¯•${MAX_RETRIES}æ¬¡ä»å¤±è´¥: ${lastError.message}`);
      }

      // ç­‰å¾…åé‡è¯•ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
      const delay = Math.min(1000 * Math.pow(2, attempt - 1), 10000); // æœ€å¤šç­‰å¾…10ç§’
      console.log(`[DeepResearch] ç­‰å¾…${delay}msåé‡è¯•...`);
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }

  // ç†è®ºä¸Šä¸ä¼šåˆ°è¿™é‡Œï¼Œä½†ä¸ºäº†ç±»å‹å®‰å…¨
  throw new Error(`DeepResearchæœåŠ¡å¼‚å¸¸ï¼Œå·²é‡è¯•${MAX_RETRIES}æ¬¡ä»å¤±è´¥`);
}

/**
 * å¥åº·æ£€æŸ¥
 */
export async function checkDeepResearchHealth() {
  try {
    const response = await axios.get(`${DEEPRESEARCH_SERVICE_URL}/health`, {
      timeout: 5000
    });
    return response.data.status === 'ok';
  } catch (error) {
    return false;
  }
}
```

#### 4.2 å®ç°generateWithDeepResearchå‡½æ•°

**æ–‡ä»¶**ï¼š`/backend/src/features/business-plan/interfaces/business-plan-routes.js`

```javascript
import { callDeepResearchService } from '../../../infrastructure/ai/deep-research-http-client.js';

async function generateWithDeepResearch(chapterId, conversationHistory, type) {
  const agent = CHAPTER_AGENTS[chapterId] || {
    name: 'æ·±åº¦ç ”ç©¶ä¸“å®¶',
    emoji: 'ğŸ”¬'
  };

  // ç›´æ¥è°ƒç”¨Pythonå¾®æœåŠ¡ï¼Œä¸åšè‡ªåŠ¨é™çº§
  // å¦‚æœå¤±è´¥ï¼Œé”™è¯¯ä¼šè¢«ä¼ é€’åˆ°å‰ç«¯ï¼Œç”±å‰ç«¯è¯¢é—®ç”¨æˆ·æ˜¯å¦é™çº§
  const result = await callDeepResearchService(chapterId, conversationHistory, type);

  return {
    chapterId: result.chapterId,
    content: result.content,
    sources: result.sources || [],
    confidence: result.confidence || 0.8,
    agent: agent.name,
    emoji: agent.emoji,
    tokens: result.tokens || 0,
    timestamp: Date.now(),
    mode: 'deep' // æ ‡è®°ä¸ºæ·±åº¦ç ”ç©¶æ¨¡å¼
  };
}
```

#### 4.3 æ·»åŠ ç¯å¢ƒå˜é‡

**æ–‡ä»¶**ï¼š`/backend/.env`

```env
# ç°æœ‰é…ç½®...
DEEPSEEK_API_KEY=your_deepseek_key

# æ–°å¢ï¼šDeepResearchæœåŠ¡é…ç½®
DEEPRESEARCH_SERVICE_URL=http://localhost:5001
DEEPRESEARCH_API_KEY=your_deepresearch_key  # å¦‚æœDeepResearchéœ€è¦APIå¯†é’¥
```

---

## å…³é”®æ–‡ä»¶æ¸…å•

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. `/index.html` - æ·»åŠ æ·±åº¦ç ”ç©¶å¼€å…³UIï¼ˆç¬¬614è¡Œåï¼‰
2. `/frontend/js/modules/business-plan-generator.js` - ä¿®æ”¹ç”Ÿæˆé€»è¾‘
   - `startGeneration()` æ–¹æ³•ï¼ˆç¬¬648è¡Œï¼‰
   - `generate()` æ–¹æ³•ï¼ˆç¬¬684è¡Œï¼‰
   - APIè°ƒç”¨éƒ¨åˆ†ï¼ˆç¬¬858è¡Œé™„è¿‘ï¼‰
3. `/backend/src/features/business-plan/interfaces/business-plan-routes.js` - ä¿®æ”¹è·¯ç”±å’Œç”Ÿæˆå‡½æ•°
   - `/generate-chapter` è·¯ç”±ï¼ˆç¬¬167è¡Œï¼‰
   - `generateSingleChapter()` å‡½æ•°ï¼ˆç¬¬75è¡Œï¼‰
   - æ–°å¢ `generateWithDeepSeek()` å’Œ `generateWithDeepResearch()` å‡½æ•°
4. `/backend/.env` - æ·»åŠ DeepResearchæœåŠ¡é…ç½®

### éœ€è¦æ–°å»ºçš„æ–‡ä»¶

1. `/backend/services/deep-research/app.py` - Flaskä¸»åº”ç”¨
2. `/backend/services/deep-research/deep_research_client.py` - DeepResearchå®¢æˆ·ç«¯
3. `/backend/services/deep-research/requirements.txt` - Pythonä¾èµ–
4. `/backend/services/deep-research/config.py` - é…ç½®æ–‡ä»¶
5. `/backend/services/deep-research/README.md` - æœåŠ¡æ–‡æ¡£
6. `/backend/src/infrastructure/ai/deep-research-http-client.js` - HTTPå®¢æˆ·ç«¯

---

## éªŒè¯è®¡åˆ’

### é˜¶æ®µä¸€éªŒè¯ï¼ˆå‰ç«¯UIï¼‰

1. æ‰“å¼€ThinkCraftï¼Œåˆ›å»ºæ–°å¯¹è¯
2. ç‚¹å‡»"ç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦"æŒ‰é’®
3. éªŒè¯ç« èŠ‚é€‰æ‹©å¼¹çª—ä¸­æ˜¾ç¤º"å¯ç”¨æ·±åº¦ç ”ç©¶æ¨¡å¼"å¼€å…³
4. å‹¾é€‰å¼€å…³ï¼Œé€‰æ‹©ç« èŠ‚ï¼Œç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"
5. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤`useDeepResearch: true`è¢«ä¼ é€’

### é˜¶æ®µäºŒéªŒè¯ï¼ˆåç«¯APIï¼‰

1. ä½¿ç”¨Postmanæˆ–curlæµ‹è¯•APIï¼š

```bash
curl -X POST http://localhost:3000/api/business-plan/generate-chapter \
  -H "Content-Type: application/json" \
  -d '{
    "chapterId": "market-analysis",
    "conversationHistory": [{"role": "user", "content": "æµ‹è¯•äº§å“"}],
    "type": "business",
    "useDeepResearch": false
  }'
```

2. éªŒè¯è¿”å›ç»“æœåŒ…å«`mode: 'fast'`
3. ä¿®æ”¹`useDeepResearch: true`ï¼ŒéªŒè¯è¿”å›é”™è¯¯æç¤º"DeepResearchæœåŠ¡å°šæœªå®ç°"

### é˜¶æ®µä¸‰éªŒè¯ï¼ˆPythonå¾®æœåŠ¡ï¼‰

1. å¯åŠ¨PythonæœåŠ¡ï¼š

```bash
cd backend/services/deep-research
pip install -r requirements.txt
python app.py
```

2. æµ‹è¯•å¥åº·æ£€æŸ¥ï¼š

```bash
curl http://localhost:5001/health
```

3. æµ‹è¯•ç« èŠ‚ç”Ÿæˆï¼š

```bash
curl -X POST http://localhost:5001/research/business-plan-chapter \
  -H "Content-Type: application/json" \
  -d '{
    "chapterId": "market-analysis",
    "conversationHistory": [{"role": "user", "content": "AIå†™ä½œåŠ©æ‰‹"}],
    "type": "business"
  }'
```

### é˜¶æ®µå››éªŒè¯ï¼ˆç«¯åˆ°ç«¯ï¼‰

1. å¯åŠ¨Pythonå¾®æœåŠ¡å’ŒNode.jsåç«¯
2. åœ¨ThinkCraftä¸­åˆ›å»ºæ–°å¯¹è¯ï¼Œè¾“å…¥äº§å“åˆ›æ„
3. ç‚¹å‡»"ç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦"ï¼Œå‹¾é€‰"å¯ç”¨æ·±åº¦ç ”ç©¶æ¨¡å¼"
4. é€‰æ‹©"å¸‚åœºåˆ†æ"ç« èŠ‚ï¼Œç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"
5. éªŒè¯ç”Ÿæˆæ—¶é—´çº¦2-3åˆ†é’Ÿï¼ˆæ¯”å¿«é€Ÿæ¨¡å¼æ…¢ï¼‰
6. æ£€æŸ¥ç”Ÿæˆçš„å†…å®¹æ˜¯å¦åŒ…å«æ•°æ®æ¥æºå’Œå¼•ç”¨
7. éªŒè¯è¿”å›ç»“æœåŒ…å«`mode: 'deep'`å’Œ`sources`å­—æ®µ

### chatIDéš”ç¦»éªŒè¯

1. åœ¨å¯¹è¯Aä¸­å¯ç”¨æ·±åº¦ç ”ç©¶æ¨¡å¼ï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦
2. åˆ‡æ¢åˆ°å¯¹è¯Bï¼Œç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦ï¼ˆä¸å¯ç”¨æ·±åº¦ç ”ç©¶ï¼‰
3. éªŒè¯å¯¹è¯Aä½¿ç”¨æ·±åº¦ç ”ç©¶ï¼Œå¯¹è¯Bä½¿ç”¨å¿«é€Ÿæ¨¡å¼
4. åˆ·æ–°é¡µé¢ï¼ŒéªŒè¯è®¾ç½®è¢«æ­£ç¡®æ¢å¤

---

## å®æ–½ä¼˜å…ˆçº§

### P0ï¼ˆç¬¬ä¸€é˜¶æ®µ - åŸºç¡€åŠŸèƒ½ï¼‰

### P1ï¼ˆç¬¬äºŒé˜¶æ®µ - Pythonå¾®æœåŠ¡ï¼‰

- [ ] PythonæœåŠ¡ï¼šå®ç°Flaskåº”ç”¨å’ŒDeepResearchå®¢æˆ·ç«¯
- [ ] Node.jsé›†æˆï¼šå®ç°HTTPå®¢æˆ·ç«¯è°ƒç”¨PythonæœåŠ¡ï¼ˆå¸¦5æ¬¡é‡è¯•æœºåˆ¶ï¼‰
- [ ] ç« èŠ‚æ”¯æŒï¼šå®ç°æ‰€æœ‰ç« èŠ‚çš„æ·±åº¦ç ”ç©¶ï¼ˆä¸åŒºåˆ†ç« èŠ‚ç±»å‹ï¼‰
- [ ] è¶…æ—¶é…ç½®ï¼šå•ç« èŠ‚è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º10åˆ†é’Ÿ
- [ ] é‡è¯•æœºåˆ¶ï¼šæœåŠ¡å¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¯•5æ¬¡ï¼Œå¤±è´¥åæç¤ºç”¨æˆ·
- [ ] é™çº§ç­–ç•¥ï¼šæœåŠ¡ä¸å¯ç”¨æ—¶è¯¢é—®ç”¨æˆ·æ˜¯å¦é™çº§åˆ°DeepSeek
- [ ] æ³¨æ„ï¼šæ·±åº¦ç ”ç©¶å¼€å…³å¯¹æ•´ç¯‡æ–‡æ¡£ç”Ÿæ•ˆï¼Œæ‰€æœ‰ç« èŠ‚ç»Ÿä¸€ä½¿ç”¨åŒä¸€æ¨¡å¼

### P2ï¼ˆç¬¬ä¸‰é˜¶æ®µ - ä¼˜åŒ–å¢å¼ºï¼‰

- [ ] æ”¯æŒæ‰€æœ‰ç« èŠ‚çš„æ·±åº¦ç ”ç©¶
- [ ] æ·»åŠ æ·±åº¦ç ”ç©¶ç»“æœçš„æ•°æ®æ¥æºå±•ç¤º
- [ ] ä¼˜åŒ–ç”Ÿæˆé€Ÿåº¦ï¼ˆå¹¶è¡Œå¤„ç†ã€ç¼“å­˜ï¼‰
- [ ] æ·»åŠ æˆæœ¬ç»Ÿè®¡å’Œé¢„ç®—æ§åˆ¶
- [ ] DockeråŒ–éƒ¨ç½²Pythonå¾®æœåŠ¡

---

## é£é™©ä¸æ³¨æ„äº‹é¡¹

### æŠ€æœ¯é£é™©

1. **DeepResearchå¯ç”¨æ€§**ï¼šéœ€è¦éªŒè¯Alibaba-NLP/DeepResearchæ˜¯å¦æä¾›å…¬å¼€APIæˆ–éœ€è¦è‡ªå»ºæœåŠ¡
2. **Pythonä¾èµ–**ï¼šDeepResearchå¯èƒ½ä¾èµ–ç‰¹å®šçš„Pythonç‰ˆæœ¬æˆ–ç³»ç»Ÿåº“
3. **æ€§èƒ½é—®é¢˜**ï¼šæ·±åº¦ç ”ç©¶æ¨¡å¼è€—æ—¶è¾ƒé•¿ï¼ˆå•ç« èŠ‚å¯èƒ½éœ€è¦5-10åˆ†é’Ÿï¼‰ï¼Œéœ€è¦ä¼˜åŒ–ç”¨æˆ·ä½“éªŒï¼ˆè¿›åº¦æç¤ºã€å¯å–æ¶ˆï¼‰
4. **æˆæœ¬æ§åˆ¶**ï¼šDeepResearchå¯èƒ½æ¶ˆè€—æ›´å¤štokensï¼Œéœ€è¦è®¾ç½®é¢„ç®—é™åˆ¶
5. **è¶…æ—¶åˆ¤æ–­**ï¼šéœ€è¦åŒºåˆ†çœŸæ­£çš„è¶…æ—¶ï¼ˆ10åˆ†é’Ÿï¼‰å’ŒæœåŠ¡å¼‚å¸¸ï¼Œé¿å…è¯¯åˆ¤

### å®æ–½æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹**ï¼šä¿æŒç°æœ‰DeepSeekå¿«é€Ÿæ¨¡å¼ä¸å—å½±å“
2. **é™çº§ç­–ç•¥**ï¼šDeepResearchæœåŠ¡ä¸å¯ç”¨æ—¶**è¯¢é—®ç”¨æˆ·**æ˜¯å¦é™çº§åˆ°DeepSeekï¼Œä¸è‡ªåŠ¨é™çº§
3. **æ•°æ®éš”ç¦»**ï¼šç¡®ä¿ä¸åŒchatIDçš„æ·±åº¦ç ”ç©¶è®¾ç½®äº’ä¸å½±å“
4. **å¼€å…³ä½œç”¨èŒƒå›´**ï¼šæ·±åº¦ç ”ç©¶å¼€å…³å¯¹æ•´ç¯‡æ–‡æ¡£ç”Ÿæ•ˆï¼Œä¸åŒºåˆ†ç« èŠ‚ç±»å‹ï¼Œæ‰€æœ‰é€‰ä¸­çš„ç« èŠ‚ç»Ÿä¸€ä½¿ç”¨åŒä¸€æ¨¡å¼
5. **è¶…æ—¶é…ç½®**ï¼šå•ç« èŠ‚è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º10åˆ†é’Ÿï¼Œé¿å…æ­£å¸¸ç”Ÿæˆè¢«è¯¯åˆ¤ä¸ºè¶…æ—¶
6. **é‡è¯•æœºåˆ¶**ï¼šè¯†åˆ«æœåŠ¡å¼‚å¸¸ï¼ˆè¿æ¥å¤±è´¥ã€500é”™è¯¯ç­‰ï¼‰ï¼Œè‡ªåŠ¨é‡è¯•5æ¬¡ï¼Œå¤±è´¥åæç¤ºç”¨æˆ·å¹¶æ”¯æŒæ‰‹åŠ¨é‡è¯•
7. **é”™è¯¯æç¤º**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯å’Œç”¨æˆ·æŒ‡å¼•
8. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ç”¨æˆ·æ–‡æ¡£ï¼Œè¯´æ˜æ·±åº¦ç ”ç©¶æ¨¡å¼çš„ä½¿ç”¨æ–¹æ³•å’Œä¼˜åŠ¿

---

---

# ç¬¬äºŒé˜¶æ®µï¼šåç»­æ‰©å±•è¯¦ç»†æ‰§è¡Œè®¡åˆ’

## æ¦‚è¿°

ç¬¬ä¸€é˜¶æ®µå®Œæˆåï¼Œç³»ç»Ÿå·²å…·å¤‡åŸºç¡€çš„DeepResearché›†æˆèƒ½åŠ›ã€‚ç¬¬äºŒé˜¶æ®µå°†åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡ŒåŠŸèƒ½æ‰©å±•å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–ï¼Œæå‡æ·±åº¦ç ”ç©¶çš„å®ç”¨æ€§å’Œå¯æ§æ€§ã€‚

---

## æ‰©å±•åŠŸèƒ½æ¸…å•

### åŠŸèƒ½1ï¼šæ·±åº¦çº§åˆ«é€‰æ‹©ï¼ˆP2-1ï¼‰

#### éœ€æ±‚æè¿°

å…è®¸ç”¨æˆ·åœ¨å¯ç”¨æ·±åº¦ç ”ç©¶æ—¶ï¼Œé€‰æ‹©ç ”ç©¶æ·±åº¦çº§åˆ«ï¼ˆæµ…å±‚/ä¸­ç­‰/æ·±åº¦ï¼‰ï¼Œå¹³è¡¡ç”Ÿæˆè´¨é‡å’Œæ—¶é—´æˆæœ¬ã€‚

#### å®æ–½æ–¹æ¡ˆ

**1.1 å‰ç«¯UIä¿®æ”¹**

**æ–‡ä»¶**ï¼š`/index.html`ï¼ˆç« èŠ‚é€‰æ‹©å¼¹çª—ï¼‰

åœ¨æ·±åº¦ç ”ç©¶å¼€å…³ä¸‹æ–¹æ·»åŠ æ·±åº¦çº§åˆ«é€‰æ‹©ï¼š

```html
<div
  class="deep-research-toggle"
  style="margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 8px;"
>
  <label style="display: flex; align-items: center; cursor: pointer;">
    <input
      type="checkbox"
      id="deepResearchSwitch"
      style="margin-right: 8px;"
      onchange="toggleDeepResearchOptions()"
    />
    <div>
      <strong>å¯ç”¨æ·±åº¦ç ”ç©¶æ¨¡å¼ï¼ˆæ•´ç¯‡æ–‡æ¡£ï¼‰</strong>
      <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--text-secondary);">
        ä½¿ç”¨DeepResearchå¯¹æ‰€æœ‰ç« èŠ‚è¿›è¡Œå¤šè½®è¿­ä»£å’Œç½‘ç»œæœç´¢ï¼Œç”Ÿæˆæ›´ä¸“ä¸šçš„æŠ¥å‘Š
      </p>
    </div>
  </label>

  <!-- æ–°å¢ï¼šæ·±åº¦çº§åˆ«é€‰æ‹© -->
  <div id="deepResearchOptions" style="display: none; margin-top: 12px; padding-left: 28px;">
    <label
      style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; display: block;"
      >ç ”ç©¶æ·±åº¦ï¼š</label
    >
    <div style="display: flex; gap: 8px;">
      <label class="depth-option">
        <input type="radio" name="researchDepth" value="shallow" style="margin-right: 4px;" />
        <span>æµ…å±‚ï¼ˆ1è½®ï¼Œçº¦2åˆ†é’Ÿ/ç« èŠ‚ï¼‰</span>
      </label>
      <label class="depth-option">
        <input
          type="radio"
          name="researchDepth"
          value="medium"
          checked
          style="margin-right: 4px;"
        />
        <span>ä¸­ç­‰ï¼ˆ3è½®ï¼Œçº¦5åˆ†é’Ÿ/ç« èŠ‚ï¼‰</span>
      </label>
      <label class="depth-option">
        <input type="radio" name="researchDepth" value="deep" style="margin-right: 4px;" />
        <span>æ·±åº¦ï¼ˆ5è½®ï¼Œçº¦10åˆ†é’Ÿ/ç« èŠ‚ï¼‰</span>
      </label>
    </div>
  </div>
</div>

<script>
  function toggleDeepResearchOptions() {
    const checkbox = document.getElementById('deepResearchSwitch');
    const options = document.getElementById('deepResearchOptions');
    options.style.display = checkbox.checked ? 'block' : 'none';
  }
</script>
```

**1.2 å‰ç«¯é€»è¾‘ä¿®æ”¹**

**æ–‡ä»¶**ï¼š`/frontend/js/modules/business-plan-generator.js`

ä¿®æ”¹`startGeneration()`æ–¹æ³•ï¼š

```javascript
async startGeneration() {
    // ... ç°æœ‰ä»£ç  ...

    // è·å–æ·±åº¦ç ”ç©¶å¼€å…³çŠ¶æ€
    const deepResearchSwitch = document.getElementById('deepResearchSwitch');
    const useDeepResearch = deepResearchSwitch ? deepResearchSwitch.checked : false;

    // æ–°å¢ï¼šè·å–ç ”ç©¶æ·±åº¦
    let researchDepth = 'medium';  // é»˜è®¤ä¸­ç­‰
    if (useDeepResearch) {
        const depthRadio = document.querySelector('input[name="researchDepth"]:checked');
        researchDepth = depthRadio ? depthRadio.value : 'medium';
    }

    logger.debug('[å¼€å§‹ç”Ÿæˆ] æ·±åº¦ç ”ç©¶:', useDeepResearch, 'ç ”ç©¶æ·±åº¦:', researchDepth);

    // å¼€å§‹ç”Ÿæˆæµç¨‹ï¼ˆä¼ é€’æ·±åº¦ç ”ç©¶æ ‡å¿—å’Œæ·±åº¦çº§åˆ«ï¼‰
    await this.generate(type, selectedChapters, useDeepResearch, researchDepth);
}
```

ä¿®æ”¹`generate()`æ–¹æ³•ç­¾åï¼š

```javascript
async generate(type, chapterIds, useDeepResearch = false, researchDepth = 'medium') {
    // ... ç°æœ‰ä»£ç  ...

    // æŒä¹…åŒ–æ—¶ä¿å­˜æ·±åº¦çº§åˆ«
    await this.persistGenerationState(chatId, type, {
        status: 'generating',
        selectedChapters: chapterIds,
        useDeepResearch,
        researchDepth,  // æ–°å¢ï¼šä¿å­˜ç ”ç©¶æ·±åº¦
        // ... å…¶ä»–å­—æ®µ ...
    });

    // åœ¨APIè°ƒç”¨æ—¶ä¼ é€’æ·±åº¦çº§åˆ«
    const response = await this.api.request('/api/business-plan/generate-chapter', {
        method: 'POST',
        body: {
            chapterId,
            conversationHistory: conversation,
            type,
            useDeepResearch,
            researchDepth  // æ–°å¢ï¼šä¼ é€’ç ”ç©¶æ·±åº¦
        },
        timeout: this._calculateTimeout(useDeepResearch, researchDepth),  // æ ¹æ®æ·±åº¦åŠ¨æ€è®¡ç®—è¶…æ—¶
        retry: 0
    });
}

// æ–°å¢ï¼šæ ¹æ®ç ”ç©¶æ·±åº¦è®¡ç®—è¶…æ—¶æ—¶é—´
_calculateTimeout(useDeepResearch, researchDepth) {
    if (!useDeepResearch) return 180000;  // å¿«é€Ÿæ¨¡å¼ï¼š3åˆ†é’Ÿ

    const timeouts = {
        shallow: 300000,   // 5åˆ†é’Ÿ
        medium: 600000,    // 10åˆ†é’Ÿ
        deep: 900000       // 15åˆ†é’Ÿ
    };

    return timeouts[researchDepth] || 600000;
}
```

**1.3 åç«¯APIä¿®æ”¹**

**æ–‡ä»¶**ï¼š`/backend/src/features/business-plan/interfaces/business-plan-routes.js`

ä¿®æ”¹è·¯ç”±æ¥æ”¶æ·±åº¦å‚æ•°ï¼š

```javascript
router.post('/generate-chapter', async (req, res, next) => {
  try {
    const {
      chapterId,
      conversationHistory,
      type = 'business',
      useDeepResearch = false,
      researchDepth = 'medium' // æ–°å¢ï¼šç ”ç©¶æ·±åº¦
    } = req.body;

    // ... å‚æ•°éªŒè¯ ...

    // ä¼ é€’æ·±åº¦å‚æ•°
    const result = await generateSingleChapter(
      chapterId,
      conversationHistory,
      type,
      useDeepResearch,
      researchDepth // æ–°å¢
    );

    res.json({ code: 0, data: result });
  } catch (error) {
    next(error);
  }
});
```

ä¿®æ”¹ç”Ÿæˆå‡½æ•°ï¼š

```javascript
async function generateSingleChapter(
  chapterId,
  conversationHistory,
  type,
  useDeepResearch,
  researchDepth
) {
  if (useDeepResearch) {
    return await generateWithDeepResearch(chapterId, conversationHistory, type, researchDepth);
  }
  return await generateWithDeepSeek(chapterId, conversationHistory, type);
}

async function generateWithDeepResearch(chapterId, conversationHistory, type, researchDepth) {
  // ... ç°æœ‰ä»£ç  ...

  // ä¼ é€’æ·±åº¦å‚æ•°åˆ°PythonæœåŠ¡
  const result = await callDeepResearchService(chapterId, conversationHistory, type, researchDepth);

  // ... è¿”å›ç»“æœ ...
}
```

**1.4 Pythonå¾®æœåŠ¡ä¿®æ”¹**

**æ–‡ä»¶**ï¼š`/backend/services/deep-research/app.py`

```python
@app.route('/research/business-plan-chapter', methods=['POST'])
def research_chapter():
    try:
        data = request.json
        chapter_id = data.get('chapterId')
        conversation_history = data.get('conversationHistory')
        doc_type = data.get('type', 'business')
        depth = data.get('researchDepth', 'medium')  # æ–°å¢ï¼šæ¥æ”¶æ·±åº¦å‚æ•°

        # æ˜ å°„æ·±åº¦çº§åˆ«åˆ°è¿­ä»£æ¬¡æ•°
        iterations_map = {
            'shallow': 1,
            'medium': 3,
            'deep': 5
        }
        iterations = iterations_map.get(depth, 3)

        # è°ƒç”¨DeepResearch
        result = client.generate_chapter(
            chapter_id=chapter_id,
            conversation_history=conversation_history,
            doc_type=doc_type,
            depth=depth,
            iterations=iterations  # æ ¹æ®æ·±åº¦è®¾ç½®è¿­ä»£æ¬¡æ•°
        )

        return jsonify({
            'chapterId': chapter_id,
            'content': result['content'],
            'sources': result.get('sources', []),
            'confidence': result.get('confidence', 0.8),
            'tokens': result.get('tokens', 0),
            'mode': 'deep',
            'depth': depth,  # è¿”å›æ·±åº¦ä¿¡æ¯
            'iterations': iterations
        })

    except Exception as e:
        return jsonify({'error': str(e)}), 500
```

#### éªŒè¯è®¡åˆ’

1. å¯ç”¨æ·±åº¦ç ”ç©¶ï¼Œé€‰æ‹©"æµ…å±‚"ï¼ŒéªŒè¯ç”Ÿæˆæ—¶é—´çº¦2åˆ†é’Ÿ/ç« èŠ‚
2. é€‰æ‹©"ä¸­ç­‰"ï¼ŒéªŒè¯ç”Ÿæˆæ—¶é—´çº¦5åˆ†é’Ÿ/ç« èŠ‚
3. é€‰æ‹©"æ·±åº¦"ï¼ŒéªŒè¯ç”Ÿæˆæ—¶é—´çº¦10åˆ†é’Ÿ/ç« èŠ‚
4. å¯¹æ¯”ä¸åŒæ·±åº¦çº§åˆ«çš„å†…å®¹è´¨é‡å·®å¼‚

---

### åŠŸèƒ½2ï¼šæ•°æ®æ¥æºå±•ç¤ºï¼ˆP2-2ï¼‰

#### éœ€æ±‚æè¿°

åœ¨ç”Ÿæˆçš„æŠ¥å‘Šä¸­æ˜¾ç¤ºå¼•ç”¨çš„æ•°æ®æ¥æºå’Œé“¾æ¥ï¼Œå¢å¼ºæŠ¥å‘Šçš„å¯ä¿¡åº¦å’Œå¯è¿½æº¯æ€§ã€‚

#### å®æ–½æ–¹æ¡ˆ

**2.1 åç«¯æ•°æ®ç»“æ„æ‰©å±•**

ç¡®ä¿DeepResearchè¿”å›çš„`sources`å­—æ®µåŒ…å«å®Œæ•´ä¿¡æ¯ï¼š

```javascript
{
    chapterId: "market-analysis",
    content: "ç”Ÿæˆçš„ç« èŠ‚å†…å®¹...",
    sources: [
        {
            title: "2024å¹´ä¸­å›½AIå¸‚åœºç ”ç©¶æŠ¥å‘Š",
            url: "https://example.com/report",
            snippet: "å¸‚åœºè§„æ¨¡è¾¾åˆ°1000äº¿å…ƒ...",
            relevance: 0.95
        },
        // ... æ›´å¤šæ¥æº
    ],
    // ... å…¶ä»–å­—æ®µ
}
```

**2.2 å‰ç«¯æŠ¥å‘Šæ¸²æŸ“ä¿®æ”¹**

**æ–‡ä»¶**ï¼š`/frontend/js/modules/report-viewer.js`ï¼ˆå‡è®¾å­˜åœ¨ï¼‰

åœ¨ç« èŠ‚å†…å®¹åæ·»åŠ æ•°æ®æ¥æºéƒ¨åˆ†ï¼š

```javascript
function renderChapterWithSources(chapter) {
  let html = `
        <div class="chapter-section">
            <h2>${chapter.title}</h2>
            <div class="chapter-content">
                ${markdownRenderer.render(chapter.content)}
            </div>
    `;

  // å¦‚æœæœ‰æ•°æ®æ¥æºï¼Œæ˜¾ç¤ºæ¥æºåˆ—è¡¨
  if (chapter.sources && chapter.sources.length > 0) {
    html += `
            <div class="chapter-sources">
                <h3>ğŸ“š æ•°æ®æ¥æº</h3>
                <ul class="sources-list">
        `;

    chapter.sources.forEach((source, index) => {
      html += `
                <li class="source-item">
                    <span class="source-number">[${index + 1}]</span>
                    <a href="${source.url}" target="_blank" class="source-link">
                        ${source.title}
                    </a>
                    ${source.snippet ? `<p class="source-snippet">${source.snippet}</p>` : ''}
                    <span class="source-relevance">ç›¸å…³åº¦: ${(source.relevance * 100).toFixed(0)}%</span>
                </li>
            `;
    });

    html += `
                </ul>
            </div>
        `;
  }

  html += `</div>`;
  return html;
}
```

**2.3 CSSæ ·å¼**

**æ–‡ä»¶**ï¼š`/frontend/css/report-viewer.css`ï¼ˆæ–°å»ºæˆ–ä¿®æ”¹ï¼‰

```css
.chapter-sources {
  margin-top: 32px;
  padding: 16px;
  background: var(--bg-secondary);
  border-radius: 8px;
  border-left: 4px solid var(--primary);
}

.chapter-sources h3 {
  margin: 0 0 16px 0;
  font-size: 16px;
  color: var(--text-primary);
}

.sources-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.source-item {
  margin-bottom: 12px;
  padding: 12px;
  background: var(--bg-primary);
  border-radius: 6px;
}

.source-number {
  display: inline-block;
  width: 24px;
  height: 24px;
  line-height: 24px;
  text-align: center;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  font-size: 12px;
  margin-right: 8px;
}

.source-link {
  color: var(--primary);
  text-decoration: none;
  font-weight: 500;
}

.source-link:hover {
  text-decoration: underline;
}

.source-snippet {
  margin: 8px 0 0 32px;
  font-size: 13px;
  color: var(--text-secondary);
  font-style: italic;
}

.source-relevance {
  display: inline-block;
  margin-left: 32px;
  font-size: 12px;
  color: var(--text-tertiary);
}
```

#### éªŒè¯è®¡åˆ’

1. ç”Ÿæˆå¸¦æ·±åº¦ç ”ç©¶çš„æŠ¥å‘Š
2. éªŒè¯æ¯ä¸ªç« èŠ‚æœ«å°¾æ˜¾ç¤ºæ•°æ®æ¥æºåˆ—è¡¨
3. ç‚¹å‡»æ¥æºé“¾æ¥ï¼ŒéªŒè¯å¯ä»¥è·³è½¬åˆ°åŸå§‹ç½‘é¡µ
4. æ£€æŸ¥æ¥æºçš„ç›¸å…³åº¦è¯„åˆ†æ˜¯å¦æ­£ç¡®æ˜¾ç¤º

---

### åŠŸèƒ½3ï¼šç½®ä¿¡åº¦è¯„åˆ†ï¼ˆP2-3ï¼‰

#### éœ€æ±‚æè¿°

åœ¨æŠ¥å‘Šä¸­æ˜¾ç¤ºæ¯ä¸ªç« èŠ‚çš„ç½®ä¿¡åº¦è¯„åˆ†ï¼Œå¸®åŠ©ç”¨æˆ·åˆ¤æ–­å†…å®¹çš„å¯é æ€§ã€‚

#### å®æ–½æ–¹æ¡ˆ

**3.1 å‰ç«¯ç« èŠ‚æ ‡é¢˜ä¿®æ”¹**

åœ¨ç« èŠ‚æ ‡é¢˜æ—æ˜¾ç¤ºç½®ä¿¡åº¦å¾½ç« ï¼š

```javascript
function renderChapterTitle(chapter) {
  const confidencePercent = (chapter.confidence * 100).toFixed(0);
  const confidenceClass =
    chapter.confidence >= 0.8 ? 'high' : chapter.confidence >= 0.6 ? 'medium' : 'low';

  return `
        <div class="chapter-header">
            <h2>${chapter.title}</h2>
            ${
              chapter.mode === 'deep'
                ? `
                <span class="confidence-badge ${confidenceClass}">
                    ç½®ä¿¡åº¦: ${confidencePercent}%
                </span>
            `
                : ''
            }
        </div>
    `;
}
```

**3.2 CSSæ ·å¼**

```css
.chapter-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.confidence-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 500;
}

.confidence-badge.high {
  background: #e8f5e9;
  color: #2e7d32;
}

.confidence-badge.medium {
  background: #fff3e0;
  color: #f57c00;
}

.confidence-badge.low {
  background: #ffebee;
  color: #c62828;
}
```

#### éªŒè¯è®¡åˆ’

1. ç”Ÿæˆæ·±åº¦ç ”ç©¶æŠ¥å‘Š
2. éªŒè¯æ¯ä¸ªç« èŠ‚æ ‡é¢˜æ—æ˜¾ç¤ºç½®ä¿¡åº¦å¾½ç« 
3. æ£€æŸ¥ä¸åŒç½®ä¿¡åº¦çš„é¢œè‰²åŒºåˆ†ï¼ˆé«˜/ä¸­/ä½ï¼‰

---

### åŠŸèƒ½4ï¼šè‡ªå®šä¹‰ç ”ç©¶é—®é¢˜ï¼ˆP2-4ï¼‰

#### éœ€æ±‚æè¿°

å…è®¸ç”¨æˆ·åœ¨å¯ç”¨æ·±åº¦ç ”ç©¶æ—¶ï¼Œä¸ºç‰¹å®šç« èŠ‚è‡ªå®šä¹‰ç ”ç©¶æ–¹å‘å’Œé—®é¢˜ï¼Œæå‡æŠ¥å‘Šçš„é’ˆå¯¹æ€§ã€‚

#### å®æ–½æ–¹æ¡ˆ

**4.1 å‰ç«¯UIä¿®æ”¹**

åœ¨ç« èŠ‚é€‰æ‹©å¼¹çª—ä¸­ï¼Œä¸ºæ¯ä¸ªç« èŠ‚æ·»åŠ "è‡ªå®šä¹‰ç ”ç©¶é—®é¢˜"æŒ‰é’®ï¼š

```html
<label class="chapter-item">
  <input type="checkbox" data-chapter="market-analysis" />
  <div class="chapter-info">
    <span class="chapter-name">å¸‚åœºåˆ†æ</span>
    <span class="chapter-desc">åˆ†æç›®æ ‡å¸‚åœºè§„æ¨¡ã€ç”¨æˆ·ç”»åƒå’Œå¸‚åœºè¶‹åŠ¿</span>
    <div>
      <span class="badge">AIè‡ªåŠ¨ç”Ÿæˆ</span>
      <button class="btn-custom-question" onclick="openCustomQuestionDialog('market-analysis')">
        è‡ªå®šä¹‰ç ”ç©¶é—®é¢˜
      </button>
    </div>
  </div>
</label>
```

**4.2 è‡ªå®šä¹‰é—®é¢˜å¯¹è¯æ¡†**

```javascript
function openCustomQuestionDialog(chapterId) {
  const dialog = `
        <div class="modal" id="customQuestionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>è‡ªå®šä¹‰ç ”ç©¶é—®é¢˜ - ${chapterId}</h3>
                    <button onclick="closeCustomQuestionDialog()">Ã—</button>
                </div>
                <div class="modal-body">
                    <p>è¯·è¾“å…¥æ‚¨å¸Œæœ›æ·±å…¥ç ”ç©¶çš„é—®é¢˜ï¼ˆæ¯è¡Œä¸€ä¸ªé—®é¢˜ï¼‰ï¼š</p>
                    <textarea id="customQuestions" rows="6" placeholder="ä¾‹å¦‚ï¼š\n1. ç›®æ ‡ç”¨æˆ·çš„å¹´é¾„åˆ†å¸ƒæ˜¯ä»€ä¹ˆï¼Ÿ\n2. ä¸»è¦ç«äº‰å¯¹æ‰‹æœ‰å“ªäº›ï¼Ÿ\n3. å¸‚åœºå¢é•¿ç‡é¢„æµ‹ï¼Ÿ"></textarea>
                </div>
                <div class="modal-footer">
                    <button onclick="saveCustomQuestions('${chapterId}')">ä¿å­˜</button>
                    <button onclick="closeCustomQuestionDialog()">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    `;

  document.body.insertAdjacentHTML('beforeend', dialog);
}

function saveCustomQuestions(chapterId) {
  const questions = document.getElementById('customQuestions').value;
  // ä¿å­˜åˆ°çŠ¶æ€ç®¡ç†å™¨
  window.businessPlanGenerator.setCustomQuestions(chapterId, questions);
  closeCustomQuestionDialog();
}
```

**4.3 åç«¯å¤„ç†**

å°†è‡ªå®šä¹‰é—®é¢˜é™„åŠ åˆ°ç ”ç©¶æŸ¥è¯¢ä¸­ï¼š

```python
def _build_research_query(self, chapter_id, conversation_history, doc_type, custom_questions=None):
    # ... ç°æœ‰çš„æŸ¥è¯¢æ„å»ºé€»è¾‘ ...

    base_query = queries.get(chapter_id, f"åŸºäºä»¥ä¸‹å†…å®¹ç”Ÿæˆ{chapter_id}ç« èŠ‚ï¼š\n{conversation_text}")

    # å¦‚æœæœ‰è‡ªå®šä¹‰é—®é¢˜ï¼Œé™„åŠ åˆ°æŸ¥è¯¢ä¸­
    if custom_questions:
        base_query += f"\n\n**ç”¨æˆ·ç‰¹åˆ«å…³æ³¨çš„é—®é¢˜**ï¼š\n{custom_questions}"

    return base_query
```

#### éªŒè¯è®¡åˆ’

1. ç‚¹å‡»"è‡ªå®šä¹‰ç ”ç©¶é—®é¢˜"æŒ‰é’®
2. è¾“å…¥è‡ªå®šä¹‰é—®é¢˜å¹¶ä¿å­˜
3. ç”ŸæˆæŠ¥å‘Šï¼ŒéªŒè¯å†…å®¹æ˜¯å¦é’ˆå¯¹è‡ªå®šä¹‰é—®é¢˜è¿›è¡Œäº†æ·±å…¥ç ”ç©¶

---

### åŠŸèƒ½5ï¼šè¿›åº¦å¯è§†åŒ–ä¼˜åŒ–ï¼ˆP2-5ï¼‰

#### éœ€æ±‚æè¿°

ä¼˜åŒ–æ·±åº¦ç ”ç©¶çš„è¿›åº¦å±•ç¤ºï¼Œæ˜¾ç¤ºå½“å‰è¿­ä»£è½®æ¬¡ã€æœç´¢è¿›åº¦ç­‰è¯¦ç»†ä¿¡æ¯ã€‚

#### å®æ–½æ–¹æ¡ˆ

**5.1 WebSocketå®æ—¶è¿›åº¦æ¨é€**

**åç«¯**ï¼šåœ¨Pythonå¾®æœåŠ¡ä¸­æ·»åŠ WebSocketæ”¯æŒ

```python
from flask_socketio import SocketIO, emit

socketio = SocketIO(app, cors_allowed_origins="*")

@app.route('/research/business-plan-chapter', methods=['POST'])
def research_chapter():
    # ... ç°æœ‰ä»£ç  ...

    # åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æ¨é€è¿›åº¦
    def progress_callback(iteration, total_iterations, status):
        socketio.emit('research_progress', {
            'chapterId': chapter_id,
            'iteration': iteration,
            'totalIterations': total_iterations,
            'status': status
        })

    result = client.generate_chapter(
        # ... å‚æ•° ...
        progress_callback=progress_callback
    )

    # ... è¿”å›ç»“æœ ...
```

**å‰ç«¯**ï¼šç›‘å¬WebSocketäº‹ä»¶

```javascript
// è¿æ¥WebSocket
const socket = io('http://localhost:5001');

socket.on('research_progress', data => {
  console.log('[DeepResearchè¿›åº¦]', data);

  // æ›´æ–°è¿›åº¦UI
  const progressText = `${data.chapterId} - ç¬¬${data.iteration}/${data.totalIterations}è½® - ${data.status}`;
  document.getElementById('deepResearchProgress').textContent = progressText;
});
```

#### éªŒè¯è®¡åˆ’

1. å¯åŠ¨æ·±åº¦ç ”ç©¶ç”Ÿæˆ
2. éªŒè¯è¿›åº¦å¼¹çª—å®æ—¶æ˜¾ç¤ºè¿­ä»£è½®æ¬¡
3. æ£€æŸ¥è¿›åº¦æ›´æ–°æ˜¯å¦æµç•…

---

### åŠŸèƒ½6ï¼šæˆæœ¬ç»Ÿè®¡å’Œé¢„ç®—æ§åˆ¶ï¼ˆP2-6ï¼‰

#### éœ€æ±‚æè¿°

ç»Ÿè®¡æ·±åº¦ç ”ç©¶çš„tokenæ¶ˆè€—å’Œæˆæœ¬ï¼Œæ”¯æŒè®¾ç½®é¢„ç®—ä¸Šé™ï¼Œé¿å…è¶…æ”¯ã€‚

#### å®æ–½æ–¹æ¡ˆ

**6.1 æˆæœ¬ç»Ÿè®¡**

åœ¨ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºæˆæœ¬æŠ¥å‘Šï¼š

```javascript
function showCostReport(report) {
  const totalTokens = report.chapters.reduce((sum, ch) => sum + ch.tokens, 0);
  const estimatedCost = (totalTokens / 1000) * 0.01; // å‡è®¾Â¥0.01/1K tokens

  alert(`
        ç”Ÿæˆå®Œæˆï¼

        æ€»Tokenæ•°: ${totalTokens.toLocaleString()}
        é¢„ä¼°æˆæœ¬: Â¥${estimatedCost.toFixed(2)}
        å¹³å‡æ¯ç« èŠ‚: ${(totalTokens / report.chapters.length).toFixed(0)} tokens
    `);
}
```

**6.2 é¢„ç®—æ§åˆ¶**

åœ¨ç« èŠ‚é€‰æ‹©å¼¹çª—æ·»åŠ é¢„ç®—è®¾ç½®ï¼š

```html
<div class="budget-control" style="margin-top: 12px;">
  <label>é¢„ç®—ä¸Šé™ï¼ˆå¯é€‰ï¼‰ï¼š</label>
  <input type="number" id="budgetLimit" placeholder="ä¾‹å¦‚ï¼š10ï¼ˆå…ƒï¼‰" step="0.1" />
  <p style="font-size: 12px; color: var(--text-secondary);">è¶…è¿‡é¢„ç®—æ—¶å°†åœæ­¢ç”Ÿæˆå¹¶æç¤º</p>
</div>
```

åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­æ£€æŸ¥é¢„ç®—ï¼š

```javascript
async generate(type, chapterIds, useDeepResearch, researchDepth) {
    const budgetLimit = parseFloat(document.getElementById('budgetLimit')?.value || 0);
    let totalCost = 0;

    for (const chapterId of chapterIds) {
        // ... ç”Ÿæˆç« èŠ‚ ...

        // ç´¯è®¡æˆæœ¬
        totalCost += (result.tokens / 1000) * 0.01;

        // æ£€æŸ¥é¢„ç®—
        if (budgetLimit > 0 && totalCost > budgetLimit) {
            const shouldContinue = confirm(
                `å·²è¶…è¿‡é¢„ç®—ä¸Šé™ï¼ˆÂ¥${budgetLimit}ï¼‰ï¼Œå½“å‰æˆæœ¬ï¼šÂ¥${totalCost.toFixed(2)}\n\n` +
                `æ˜¯å¦ç»§ç»­ç”Ÿæˆå‰©ä½™ç« èŠ‚ï¼Ÿ`
            );

            if (!shouldContinue) {
                break;
            }
        }
    }
}
```

#### éªŒè¯è®¡åˆ’

1. è®¾ç½®é¢„ç®—ä¸Šé™ä¸ºÂ¥5
2. ç”ŸæˆæŠ¥å‘Šï¼ŒéªŒè¯è¶…è¿‡é¢„ç®—æ—¶å¼¹å‡ºæç¤º
3. éªŒè¯æˆæœ¬ç»Ÿè®¡çš„å‡†ç¡®æ€§

---

## å®æ–½ä¼˜å…ˆçº§

### P2-1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

- [ ] åŠŸèƒ½1ï¼šæ·±åº¦çº§åˆ«é€‰æ‹©
- [ ] åŠŸèƒ½2ï¼šæ•°æ®æ¥æºå±•ç¤º
- [ ] åŠŸèƒ½5ï¼šè¿›åº¦å¯è§†åŒ–ä¼˜åŒ–

### P2-2ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

- [ ] åŠŸèƒ½3ï¼šç½®ä¿¡åº¦è¯„åˆ†
- [ ] åŠŸèƒ½6ï¼šæˆæœ¬ç»Ÿè®¡å’Œé¢„ç®—æ§åˆ¶

### P2-3ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

- [ ] åŠŸèƒ½4ï¼šè‡ªå®šä¹‰ç ”ç©¶é—®é¢˜

---

## éªŒè¯æ¸…å•

### æ·±åº¦çº§åˆ«é€‰æ‹©

- [ ] æµ…å±‚æ¨¡å¼ç”Ÿæˆæ—¶é—´çº¦2åˆ†é’Ÿ/ç« èŠ‚
- [ ] ä¸­ç­‰æ¨¡å¼ç”Ÿæˆæ—¶é—´çº¦5åˆ†é’Ÿ/ç« èŠ‚
- [ ] æ·±åº¦æ¨¡å¼ç”Ÿæˆæ—¶é—´çº¦10åˆ†é’Ÿ/ç« èŠ‚
- [ ] ä¸åŒæ·±åº¦çš„å†…å®¹è´¨é‡æœ‰æ˜æ˜¾å·®å¼‚

### æ•°æ®æ¥æºå±•ç¤º

- [ ] æŠ¥å‘Šä¸­æ˜¾ç¤ºæ•°æ®æ¥æºåˆ—è¡¨
- [ ] æ¥æºé“¾æ¥å¯ç‚¹å‡»è·³è½¬
- [ ] ç›¸å…³åº¦è¯„åˆ†æ­£ç¡®æ˜¾ç¤º

### ç½®ä¿¡åº¦è¯„åˆ†

- [ ] ç« èŠ‚æ ‡é¢˜æ—æ˜¾ç¤ºç½®ä¿¡åº¦å¾½ç« 
- [ ] ä¸åŒç½®ä¿¡åº¦çš„é¢œè‰²åŒºåˆ†æ­£ç¡®

### è‡ªå®šä¹‰ç ”ç©¶é—®é¢˜

- [ ] å¯ä»¥ä¸ºç« èŠ‚æ·»åŠ è‡ªå®šä¹‰é—®é¢˜
- [ ] ç”Ÿæˆå†…å®¹é’ˆå¯¹è‡ªå®šä¹‰é—®é¢˜è¿›è¡Œäº†ç ”ç©¶

### è¿›åº¦å¯è§†åŒ–

- [ ] å®æ—¶æ˜¾ç¤ºè¿­ä»£è½®æ¬¡
- [ ] è¿›åº¦æ›´æ–°æµç•…

### æˆæœ¬ç»Ÿè®¡

- [ ] ç”Ÿæˆå®Œæˆåæ˜¾ç¤ºæˆæœ¬æŠ¥å‘Š
- [ ] é¢„ç®—æ§åˆ¶åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] è¶…è¿‡é¢„ç®—æ—¶æ­£ç¡®æç¤º

---

## å…³é”®æ–‡ä»¶æ¸…å•ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. `/index.html` - æ·»åŠ æ·±åº¦çº§åˆ«é€‰æ‹©ã€è‡ªå®šä¹‰é—®é¢˜ã€é¢„ç®—æ§åˆ¶UI
2. `/frontend/js/modules/business-plan-generator.js` - æ‰©å±•ç”Ÿæˆé€»è¾‘
3. `/frontend/js/modules/report-viewer.js` - æ·»åŠ æ•°æ®æ¥æºå’Œç½®ä¿¡åº¦å±•ç¤º
4. `/frontend/css/report-viewer.css` - æ–°å¢æ ·å¼
5. `/backend/src/features/business-plan/interfaces/business-plan-routes.js` - æ¥æ”¶æ‰©å±•å‚æ•°
6. `/backend/services/deep-research/app.py` - æ”¯æŒæ·±åº¦çº§åˆ«ã€è‡ªå®šä¹‰é—®é¢˜ã€è¿›åº¦æ¨é€
7. `/backend/services/deep-research/deep_research_client.py` - æ‰©å±•å®¢æˆ·ç«¯åŠŸèƒ½

### éœ€è¦æ–°å»ºçš„æ–‡ä»¶

1. `/frontend/js/components/custom-question-dialog.js` - è‡ªå®šä¹‰é—®é¢˜å¯¹è¯æ¡†ç»„ä»¶
2. `/frontend/js/utils/cost-calculator.js` - æˆæœ¬è®¡ç®—å·¥å…·
3. `/backend/services/deep-research/websocket_handler.py` - WebSocketè¿›åº¦æ¨é€

---

## æ—¶é—´ä¼°ç®—

| åŠŸèƒ½               | é¢„ä¼°æ—¶é—´ | ä¼˜å…ˆçº§ |
| ------------------ | -------- | ------ |
| æ·±åº¦çº§åˆ«é€‰æ‹©       | 1-2å¤©    | P2-1   |
| æ•°æ®æ¥æºå±•ç¤º       | 1å¤©      | P2-1   |
| ç½®ä¿¡åº¦è¯„åˆ†         | 0.5å¤©    | P2-2   |
| è‡ªå®šä¹‰ç ”ç©¶é—®é¢˜     | 2-3å¤©    | P2-3   |
| è¿›åº¦å¯è§†åŒ–ä¼˜åŒ–     | 2å¤©      | P2-1   |
| æˆæœ¬ç»Ÿè®¡å’Œé¢„ç®—æ§åˆ¶ | 1å¤©      | P2-2   |

**æ€»è®¡**ï¼šçº¦7-9å¤©

---

## é£é™©æç¤º

1. **WebSocketå…¼å®¹æ€§**ï¼šéœ€è¦ç¡®ä¿å‰åç«¯WebSocketåº“ç‰ˆæœ¬å…¼å®¹
2. **æˆæœ¬è®¡ç®—å‡†ç¡®æ€§**ï¼šä¸åŒæ¨¡å‹çš„tokenè®¡è´¹æ–¹å¼å¯èƒ½ä¸åŒï¼Œéœ€è¦åŠ¨æ€é…ç½®
3. **è‡ªå®šä¹‰é—®é¢˜è§£æ**ï¼šéœ€è¦å¤„ç†ç”¨æˆ·è¾“å…¥çš„å„ç§æ ¼å¼ï¼Œé¿å…è§£æé”™è¯¯
4. **è¿›åº¦æ¨é€æ€§èƒ½**ï¼šé«˜é¢‘ç‡çš„è¿›åº¦æ¨é€å¯èƒ½å½±å“æ€§èƒ½ï¼Œéœ€è¦èŠ‚æµå¤„ç†

---

## ä»£ç çº§æ£€æµ‹æœªå®Œæˆé¡¹ï¼ˆåŸºäºå½“å‰å®ç°ï¼‰

1. WebSocket å®æ—¶è¿›åº¦æ¨é€/è¿­ä»£è¿›åº¦ï¼ˆæœªå‘ç° websocket_handler æˆ– WS è·¯ç”±ï¼‰
2. è‡ªå®šä¹‰ç ”ç©¶é—®é¢˜ï¼ˆå‰åç«¯è¯·æ±‚ä½“ä¸æœåŠ¡æœªæ¥å…¥è¯¥å­—æ®µï¼‰
3. ç½®ä¿¡åº¦å¾½ç« ä¸é¢œè‰²åŒºåˆ†ï¼ˆä»…è¿”å› confidenceï¼Œæœªæ¸²æŸ“ UIï¼‰
4. æ•°æ®æ¥æºç›¸å…³åº¦è¯„åˆ†ï¼ˆsources æ— ç›¸å…³åº¦å­—æ®µä¸å±•ç¤ºï¼‰
5. æ¥æºé“¾æ¥å¯ç‚¹å‡»è·³è½¬ï¼ˆURL ä»…æ–‡æœ¬å±•ç¤ºï¼‰
6. æˆæœ¬ç»Ÿè®¡ä¸é¢„ç®—æ§åˆ¶ï¼ˆä»… DeepSeek ç»Ÿè®¡ï¼ŒDeepResearch æœªæ¥å…¥ï¼‰
7. Docker åŒ–éƒ¨ç½² Python å¾®æœåŠ¡ï¼ˆç¼ºå°‘ Dockerfileï¼‰
8. è¿›åº¦å¯è§†åŒ–ä¼˜åŒ–ï¼ˆä»…ç« èŠ‚çº§è¿›åº¦ï¼Œæ— è¿­ä»£è½®æ¬¡/æœç´¢è¿›åº¦ï¼‰
