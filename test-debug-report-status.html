<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯•æŠ¥å‘ŠçŠ¶æ€é—®é¢˜</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .debug-section {
            background: #252526;
            padding: 15px;
            margin: 10px 0;
            border-left: 3px solid #007acc;
            border-radius: 4px;
        }
        h2 {
            color: #4ec9b0;
            margin-top: 0;
        }
        .code {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .warning {
            color: #ce9178;
        }
        .error {
            color: #f48771;
        }
        .success {
            color: #4ec9b0;
        }
        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1177bb;
        }
        #output {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            max-height: 500px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 2px solid #007acc;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è°ƒè¯•æŠ¥å‘ŠçŠ¶æ€é—®é¢˜</h1>

    <div class="debug-section">
        <h2>è°ƒè¯•æ­¥éª¤</h2>
        <p>1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰</p>
        <p>2. åˆ‡æ¢åˆ° Console æ ‡ç­¾</p>
        <p>3. ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æ‰§è¡Œè°ƒè¯•å‘½ä»¤</p>
    </div>

    <div class="debug-section">
        <h2>è°ƒè¯•å‘½ä»¤</h2>
        <button onclick="checkCurrentChat()">1. æ£€æŸ¥å½“å‰å¯¹è¯ID</button>
        <button onclick="checkIndexedDB()">2. æ£€æŸ¥IndexedDBæ•°æ®</button>
        <button onclick="checkButtonState()">3. æ£€æŸ¥æŒ‰é’®çŠ¶æ€</button>
        <button onclick="testLoadStates()">4. æµ‹è¯•åŠ è½½çŠ¶æ€</button>
        <button onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
    </div>

    <div class="debug-section">
        <h2>è¾“å‡º</h2>
        <div id="output"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f48771' : type === 'success' ? '#4ec9b0' : type === 'warning' ? '#ce9178' : '#d4d4d4';
            entry.innerHTML = `<span style="color: #858585">[${timestamp}]</span> <span style="color: ${color}">${message}</span>`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        function checkCurrentChat() {
            log('=== æ£€æŸ¥å½“å‰å¯¹è¯ID ===', 'info');
            if (typeof state !== 'undefined' && state.currentChat) {
                log(`âœ… å½“å‰å¯¹è¯ID: ${state.currentChat}`, 'success');
                log(`   ç±»å‹: ${typeof state.currentChat}`, 'info');
            } else {
                log('âŒ æœªæ‰¾åˆ° state.currentChat', 'error');
                log('   å¯èƒ½åŸå› ï¼šé¡µé¢æœªå®Œå…¨åŠ è½½æˆ–å˜é‡åä¸åŒ', 'warning');
            }
        }

        async function checkIndexedDB() {
            log('=== æ£€æŸ¥IndexedDBæ•°æ® ===', 'info');

            if (!window.storageManager) {
                log('âŒ storageManager æœªå®šä¹‰', 'error');
                return;
            }

            if (typeof state === 'undefined' || !state.currentChat) {
                log('âŒ æ— æ³•è·å–å½“å‰å¯¹è¯ID', 'error');
                return;
            }

            try {
                const chatId = String(state.currentChat);
                log(`ğŸ“Š æŸ¥è¯¢å¯¹è¯ID: ${chatId}`, 'info');

                const reports = await window.storageManager.getReportsByChatId(chatId);

                if (!reports || reports.length === 0) {
                    log('âš ï¸  æœªæ‰¾åˆ°ä»»ä½•æŠ¥å‘Š', 'warning');
                    return;
                }

                log(`âœ… æ‰¾åˆ° ${reports.length} ä¸ªæŠ¥å‘Š`, 'success');

                reports.forEach((report, index) => {
                    log(`\n--- æŠ¥å‘Š ${index + 1} ---`, 'info');
                    log(`  ç±»å‹: ${report.type}`, 'info');
                    log(`  çŠ¶æ€: ${report.status}`, report.status === 'completed' ? 'success' : 'warning');
                    log(`  chatId: ${report.chatId}`, 'info');
                    log(`  æœ‰æ•°æ®: ${report.data ? 'æ˜¯' : 'å¦'}`, report.data ? 'success' : 'warning');
                    if (report.selectedChapters) {
                        log(`  é€‰ä¸­ç« èŠ‚: ${report.selectedChapters.length} ä¸ª`, 'info');
                    }
                    if (report.error) {
                        log(`  é”™è¯¯: ${report.error.message}`, 'error');
                    }
                });
            } catch (error) {
                log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        function checkButtonState() {
            log('=== æ£€æŸ¥æŒ‰é’®çŠ¶æ€ ===', 'info');

            const buttons = {
                'business': 'businessPlanBtn',
                'proposal': 'proposalBtn',
                'analysis': 'analysisReportBtn'
            };

            Object.keys(buttons).forEach(type => {
                const btnId = buttons[type];
                const btn = document.getElementById(btnId);

                if (!btn) {
                    log(`âŒ æœªæ‰¾åˆ°æŒ‰é’®: ${btnId}`, 'error');
                    return;
                }

                log(`\n--- ${type} æŒ‰é’® ---`, 'info');
                log(`  ID: ${btnId}`, 'info');
                log(`  çŠ¶æ€: ${btn.dataset.status || 'æœªè®¾ç½®'}`, 'info');
                log(`  ç±»å: ${btn.className}`, 'info');
                log(`  ç¦ç”¨: ${btn.disabled}`, 'info');

                const iconSpan = btn.querySelector('.btn-icon');
                const textSpan = btn.querySelector('.btn-text');

                if (iconSpan) {
                    log(`  å›¾æ ‡: ${iconSpan.textContent}`, 'info');
                }
                if (textSpan) {
                    log(`  æ–‡æœ¬: ${textSpan.textContent}`, 'info');
                }
            });
        }

        async function testLoadStates() {
            log('=== æµ‹è¯•åŠ è½½çŠ¶æ€å‡½æ•° ===', 'info');

            if (typeof loadGenerationStatesForChat !== 'function') {
                log('âŒ loadGenerationStatesForChat å‡½æ•°æœªå®šä¹‰', 'error');
                return;
            }

            if (typeof state === 'undefined' || !state.currentChat) {
                log('âŒ æ— æ³•è·å–å½“å‰å¯¹è¯ID', 'error');
                return;
            }

            try {
                log('ğŸ”„ å¼€å§‹åŠ è½½çŠ¶æ€...', 'info');
                const startTime = performance.now();

                await loadGenerationStatesForChat(state.currentChat);

                const duration = performance.now() - startTime;
                log(`âœ… åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${duration.toFixed(2)}ms`, 'success');

                // å†æ¬¡æ£€æŸ¥æŒ‰é’®çŠ¶æ€
                setTimeout(() => {
                    log('\næ£€æŸ¥åŠ è½½åçš„æŒ‰é’®çŠ¶æ€:', 'info');
                    checkButtonState();
                }, 100);

            } catch (error) {
                log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.addEventListener('load', () => {
            log('ğŸ“ è°ƒè¯•å·¥å…·å·²å°±ç»ª', 'success');
            log('è¯·æŒ‰é¡ºåºç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è¿›è¡Œè°ƒè¯•', 'info');
        });
    </script>

    <div class="debug-section">
        <h2>å¯èƒ½çš„é—®é¢˜åŸå› </h2>
        <div class="code">
<span class="warning">1. IndexedDBä¸­æ²¡æœ‰æ•°æ®</span>
   - æŠ¥å‘Šå¯èƒ½æ²¡æœ‰æ­£ç¡®ä¿å­˜åˆ°IndexedDB
   - chatIdå¯èƒ½ä¸åŒ¹é…

<span class="warning">2. æŒ‰é’®å…ƒç´ æœªæ‰¾åˆ°</span>
   - æŒ‰é’®IDå¯èƒ½ä¸æ­£ç¡®
   - å¼¹çª—å¯èƒ½è¿˜æœªæ¸²æŸ“

<span class="warning">3. çŠ¶æ€åŠ è½½æ—¶æœºé—®é¢˜</span>
   - loadGenerationStatesForChat å¯èƒ½åœ¨æŒ‰é’®æ¸²æŸ“å‰æ‰§è¡Œ
   - éœ€è¦ç¡®ä¿æŒ‰é’®å·²å­˜åœ¨äºDOMä¸­

<span class="warning">4. çŠ¶æ€æ›´æ–°é€»è¾‘é—®é¢˜</span>
   - report.status å¯èƒ½ä¸º undefined
   - æŒ‰é’®æ›´æ–°é€»è¾‘å¯èƒ½æœ‰bug
        </div>
    </div>

    <div class="debug-section">
        <h2>æ‰‹åŠ¨æµ‹è¯•å‘½ä»¤ï¼ˆåœ¨Consoleä¸­æ‰§è¡Œï¼‰</h2>
        <div class="code">
// 1. æ£€æŸ¥å½“å‰å¯¹è¯
console.log('å½“å‰å¯¹è¯:', state.currentChat);

// 2. æŸ¥è¯¢IndexedDB
window.storageManager.getReportsByChatId(String(state.currentChat))
    .then(reports => console.log('æŠ¥å‘Š:', reports));

// 3. æ£€æŸ¥æŒ‰é’®
console.log('å•†ä¸šè®¡åˆ’ä¹¦æŒ‰é’®:', document.getElementById('businessPlanBtn'));

// 4. æ‰‹åŠ¨åŠ è½½çŠ¶æ€
await loadGenerationStatesForChat(state.currentChat);

// 5. æ£€æŸ¥ generatedReports å¯¹è±¡
console.log('generatedReports:', generatedReports);
        </div>
    </div>
</body>
</html>
