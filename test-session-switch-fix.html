<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会话切换状态隔离测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 0;
        }
        .test-case {
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 10px 0;
        }
        .test-case h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .test-steps {
            list-style: none;
            padding: 0;
        }
        .test-steps li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .test-steps li:last-child {
            border-bottom: none;
        }
        .expected {
            background: #E8F5E9;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .expected strong {
            color: #4CAF50;
        }
        .code {
            background: #263238;
            color: #ADBAC7;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        .warning {
            background: #FFF3E0;
            border-left: 4px solid #FF9800;
            padding: 15px;
            margin: 10px 0;
        }
        .success {
            background: #E8F5E9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 10px 0;
        }
        .key-changes {
            background: #E3F2FD;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .key-changes ul {
            margin: 10px 0;
        }
        .key-changes li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 会话切换时报告生成状态混淆问题修复 - 测试指南</h1>

    <div class="test-section">
        <h2>📋 问题描述</h2>
        <p>切换会话时，不同会话的报告生成状态存在混淆。一个会话在生成报告时，切换到另一个会话，另一个会话的按钮也会被错误地标记为"生成中"状态。</p>
    </div>

    <div class="test-section">
        <h2>🎯 修复目标</h2>
        <ul>
            <li>✅ 统一 chatId 类型为字符串，避免类型不一致导致的状态混淆</li>
            <li>✅ 增强状态隔离验证，确保每个会话的状态独立</li>
            <li>✅ 会话切换时主动清理前一个会话的内存状态</li>
            <li>✅ 按钮状态关联 chatId，验证时检查匹配</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>🔑 关键修改点</h2>
        <div class="key-changes">
            <h3>1. state-manager.js</h3>
            <ul>
                <li>所有生成状态相关方法添加 <code>const normalizedChatId = String(chatId);</code></li>
                <li>新增 <code>clearGenerationState(chatId)</code> 方法用于清理会话状态</li>
            </ul>

            <h3>2. app-boot.js</h3>
            <ul>
                <li><code>loadGenerationStatesForChat</code>: 添加报告验证，过滤不匹配的报告</li>
                <li><code>handleGenerationBtnClick</code>: 添加按钮 chatId 验证</li>
                <li><code>loadChat</code>: 会话切换时清理前一个会话的状态</li>
                <li><code>resetGenerationButtons</code>: 支持 excludeChatId 参数</li>
                <li>按钮更新时设置 <code>btn.dataset.chatId</code></li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>🧪 测试场景</h2>

        <div class="test-case">
            <h3>测试场景 1：跨会话状态隔离</h3>
            <ol class="test-steps">
                <li><strong>步骤 1:</strong> 创建会话 A，开始生成商业计划书</li>
                <li><strong>步骤 2:</strong> 在生成过程中，切换到会话 B</li>
                <li><strong>步骤 3:</strong> 观察会话 B 的按钮状态</li>
            </ol>
            <div class="expected">
                <strong>预期结果:</strong> 会话 B 的所有按钮应该是 idle 状态（📊 商业计划书、📋 产品立项材料），不应该显示会话 A 的 generating 状态
            </div>
            <div class="warning">
                <strong>⚠️ 修复前的问题:</strong> 会话 B 的按钮会错误地显示为"生成中"状态
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景 2：会话切换后返回</h3>
            <ol class="test-steps">
                <li><strong>步骤 1:</strong> 在会话 A 中生成完成商业计划书</li>
                <li><strong>步骤 2:</strong> 切换到会话 B</li>
                <li><strong>步骤 3:</strong> 再切换回会话 A</li>
                <li><strong>步骤 4:</strong> 点击商业计划书按钮</li>
            </ol>
            <div class="expected">
                <strong>预期结果:</strong> 会话 A 的按钮应该显示 completed 状态（✅ 商业计划书（查看）），点击可以查看报告
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景 3：并发生成</h3>
            <ol class="test-steps">
                <li><strong>步骤 1:</strong> 在会话 A 中开始生成商业计划书（不等待完成）</li>
                <li><strong>步骤 2:</strong> 切换到会话 B</li>
                <li><strong>步骤 3:</strong> 在会话 B 中开始生成产品立项材料</li>
                <li><strong>步骤 4:</strong> 分别切换回会话 A 和会话 B 查看状态</li>
            </ol>
            <div class="expected">
                <strong>预期结果:</strong> 两个会话的生成任务应该独立进行，互不干扰。会话 A 显示商业计划书生成中，会话 B 显示产品立项材料生成中
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景 4：页面刷新恢复</h3>
            <ol class="test-steps">
                <li><strong>步骤 1:</strong> 在会话 A 中生成完成商业计划书</li>
                <li><strong>步骤 2:</strong> 刷新页面（F5 或 Ctrl+R）</li>
                <li><strong>步骤 3:</strong> 切换到会话 A</li>
                <li><strong>步骤 4:</strong> 观察按钮状态</li>
            </ol>
            <div class="expected">
                <strong>预期结果:</strong> 按钮应该显示 completed 状态，报告数据正确加载
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景 5：错误状态恢复</h3>
            <ol class="test-steps">
                <li><strong>步骤 1:</strong> 在会话 A 中生成报告失败（可以通过断网或关闭后端模拟）</li>
                <li><strong>步骤 2:</strong> 切换到会话 B</li>
                <li><strong>步骤 3:</strong> 再切换回会话 A</li>
                <li><strong>步骤 4:</strong> 观察按钮状态</li>
            </ol>
            <div class="expected">
                <strong>预期结果:</strong> 按钮应该显示 error 状态（❌ 生成失败（重试）），不应该显示 generating 状态
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>🔍 调试技巧</h2>
        <p>打开浏览器开发者工具（F12），在 Console 中查看日志：</p>
        <div class="code">
// 查看会话切换日志
[会话切换] 从会话 X 切换到 Y
[会话切换] 清理 business 报告数据（属于会话 X）

// 查看状态加载日志
[加载状态] 开始加载，chatId: Y
[加载状态] 从内存获取 business 状态: {...}
[加载状态] 验证后的报告: [...]

// 查看按钮状态日志
[生成按钮点击] 按钮状态 { btnId: 'businessPlanBtn', currentStatus: 'completed', btnChatId: 'Y', currentChatId: 'Y' }

// 查看 StateManager 清理日志
[StateManager] 清理会话 X 的生成状态
        </div>
    </div>

    <div class="test-section">
        <h2>📊 验证检查清单</h2>
        <ul>
            <li>☐ 会话 A 生成中，切换到会话 B，会话 B 按钮为 idle</li>
            <li>☐ 会话 A 生成完成，切换到会话 B 再回到 A，按钮为 completed</li>
            <li>☐ 两个会话同时生成，状态互不干扰</li>
            <li>☐ 页面刷新后，状态正确恢复</li>
            <li>☐ 错误状态正确显示，不会误显示为 generating</li>
            <li>☐ Console 中没有 chatId 类型不一致的警告</li>
            <li>☐ 按钮的 dataset.chatId 与当前会话 ID 匹配</li>
        </ul>
    </div>

    <div class="test-section success">
        <h2>✅ 修复完成</h2>
        <p>所有计划中的修改已完成：</p>
        <ul>
            <li>✅ state-manager.js: 统一 chatId 类型处理，新增清理方法</li>
            <li>✅ app-boot.js: 增强状态加载、验证、清理逻辑</li>
            <li>✅ 代码已通过语法检查</li>
        </ul>
        <p><strong>请按照上述测试场景进行验证，确认修复效果。</strong></p>
    </div>

    <div class="test-section">
        <h2>📝 注意事项</h2>
        <ul>
            <li>测试时建议使用不同的项目创意，以便区分不同会话</li>
            <li>观察 Console 日志，确认状态隔离逻辑正确执行</li>
            <li>如果发现问题，请记录详细的复现步骤和 Console 日志</li>
            <li>测试完成后，可以删除此测试页面</li>
        </ul>
    </div>
</body>
</html>
