<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StateManager 修复验证</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            margin-top: 0;
            color: #333;
        }
        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .test-item.pass {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }
        .test-item.fail {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .test-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .test-result {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
        .summary {
            font-size: 18px;
            font-weight: bold;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
        .summary.pass {
            background: #4caf50;
            color: white;
        }
        .summary.fail {
            background: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>StateManager 修复验证测试</h1>

    <div class="test-section">
        <h2>测试控制</h2>
        <button onclick="runAllTests()">运行所有测试</button>
        <button onclick="location.reload()">刷新页面</button>
    </div>

    <div id="results"></div>

    <!-- 加载必要的脚本 -->
    <script src="frontend/js/boot/legacy/index-app-state.js"></script>
    <script src="frontend/js/core/state-manager.js"></script>

    <script>
        const results = [];

        function addTest(name, passed, details) {
            results.push({ name, passed, details });
            renderResults();
        }

        function renderResults() {
            const container = document.getElementById('results');
            const passCount = results.filter(r => r.passed).length;
            const failCount = results.filter(r => !r.passed).length;

            let html = `
                <div class="summary ${failCount === 0 ? 'pass' : 'fail'}">
                    测试结果: ${passCount} 通过, ${failCount} 失败
                </div>
            `;

            results.forEach(test => {
                html += `
                    <div class="test-item ${test.passed ? 'pass' : 'fail'}">
                        <div class="test-label">
                            ${test.passed ? '✅' : '❌'} ${test.name}
                        </div>
                        <div class="test-result">${test.details}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function runAllTests() {
            results.length = 0;
            renderResults();

            // 测试1: window.state 存在
            addTest(
                'window.state 存在',
                typeof window.state === 'object' && window.state !== null,
                `window.state = ${JSON.stringify(window.state, null, 2).substring(0, 200)}...`
            );

            // 测试2: window.stateManager 存在
            addTest(
                'window.stateManager 存在',
                typeof window.stateManager === 'object' && window.stateManager !== null,
                `window.stateManager = ${window.stateManager}`
            );

            // 测试3: stateManager.state 存在
            addTest(
                'stateManager.state 存在',
                window.stateManager && typeof window.stateManager.state === 'object',
                `stateManager.state = ${JSON.stringify(window.stateManager?.state, null, 2).substring(0, 200)}...`
            );

            // 测试4: window.state === stateManager.state
            const sameReference = window.state === window.stateManager?.state;
            addTest(
                'window.state === stateManager.state (数据同步)',
                sameReference,
                `相同引用: ${sameReference}`
            );

            // 测试5: startGeneration 方法存在
            addTest(
                'startGeneration 方法存在',
                typeof window.stateManager?.startGeneration === 'function',
                `typeof startGeneration = ${typeof window.stateManager?.startGeneration}`
            );

            // 测试6: getGenerationState 方法存在
            addTest(
                'getGenerationState 方法存在',
                typeof window.stateManager?.getGenerationState === 'function',
                `typeof getGenerationState = ${typeof window.stateManager?.getGenerationState}`
            );

            // 测试7: completeGeneration 方法存在
            addTest(
                'completeGeneration 方法存在',
                typeof window.stateManager?.completeGeneration === 'function',
                `typeof completeGeneration = ${typeof window.stateManager?.completeGeneration}`
            );

            // 测试8: errorGeneration 方法存在
            addTest(
                'errorGeneration 方法存在',
                typeof window.stateManager?.errorGeneration === 'function',
                `typeof errorGeneration = ${typeof window.stateManager?.errorGeneration}`
            );

            // 测试9: resetGeneration 方法存在
            addTest(
                'resetGeneration 方法存在',
                typeof window.stateManager?.resetGeneration === 'function',
                `typeof resetGeneration = ${typeof window.stateManager?.resetGeneration}`
            );

            // 测试10: updateProgress 方法存在
            addTest(
                'updateProgress 方法存在',
                typeof window.stateManager?.updateProgress === 'function',
                `typeof updateProgress = ${typeof window.stateManager?.updateProgress}`
            );

            // 测试11: getConversationHistory 方法存在
            addTest(
                'getConversationHistory 方法存在',
                typeof window.stateManager?.getConversationHistory === 'function',
                `typeof getConversationHistory = ${typeof window.stateManager?.getConversationHistory}`
            );

            // 测试12: generation 属性存在
            addTest(
                'state.generation 属性存在',
                window.state && typeof window.state.generation === 'object',
                `state.generation = ${JSON.stringify(window.state?.generation)}`
            );

            // 测试13: 测试 startGeneration 方法
            try {
                window.stateManager.startGeneration('test-chat-id', 'business', ['chapter1', 'chapter2']);
                const genState = window.stateManager.getGenerationState('test-chat-id');
                const hasBusinessState = genState && genState.business && genState.business.status === 'generating';
                addTest(
                    'startGeneration 方法功能正常',
                    hasBusinessState,
                    `生成状态: ${JSON.stringify(genState?.business, null, 2)}`
                );
            } catch (error) {
                addTest(
                    'startGeneration 方法功能正常',
                    false,
                    `错误: ${error.message}`
                );
            }

            // 测试14: 测试 updateProgress 方法
            try {
                window.stateManager.updateProgress('test-chat-id', 'business', 'chapter1', 1);
                const genState = window.stateManager.getGenerationState('test-chat-id');
                const hasProgress = genState && genState.business && genState.business.progress;
                addTest(
                    'updateProgress 方法功能正常',
                    hasProgress,
                    `进度: ${JSON.stringify(genState?.business?.progress, null, 2)}`
                );
            } catch (error) {
                addTest(
                    'updateProgress 方法功能正常',
                    false,
                    `错误: ${error.message}`
                );
            }

            // 测试15: 测试 completeGeneration 方法
            try {
                window.stateManager.completeGeneration('test-chat-id', 'business', { test: 'data' });
                const genState = window.stateManager.getGenerationState('test-chat-id');
                const isCompleted = genState && genState.business && genState.business.status === 'completed';
                addTest(
                    'completeGeneration 方法功能正常',
                    isCompleted,
                    `完成状态: ${JSON.stringify(genState?.business, null, 2)}`
                );
            } catch (error) {
                addTest(
                    'completeGeneration 方法功能正常',
                    false,
                    `错误: ${error.message}`
                );
            }

            // 测试16: window.reportButtonManager 存在
            addTest(
                'window.reportButtonManager 存在（按钮管理器）',
                typeof window.reportButtonManager === 'object',
                `window.reportButtonManager = ${window.reportButtonManager}`
            );

            console.log('所有测试完成！');
        }

        // 页面加载后自动运行测试
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
