<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•†ä¸šè®¡åˆ’ä¹¦è¿›åº¦ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 0;
        }
        .test-item {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .test-item h3 {
            margin-top: 0;
            color: #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .error {
            background: #ffebee;
            color: #c62828;
        }
        .success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .info {
            background: #e3f2fd;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ å•†ä¸šè®¡åˆ’ä¹¦è¿›åº¦ä¿®å¤æµ‹è¯•</h1>

    <div class="test-section">
        <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•å•†ä¸šè®¡åˆ’ä¹¦å’Œäº§å“ç«‹é¡¹ææ–™è¿›åº¦å¡åœ¨ 0% çš„ä¿®å¤æ–¹æ¡ˆã€‚</p>
        <p><strong>ä¿®å¤å†…å®¹ï¼š</strong></p>
        <ul>
            <li>âœ… å¢å¼ºé”™è¯¯æ—¥å¿—å’Œç”¨æˆ·åé¦ˆ</li>
            <li>âœ… æ”¹è¿›ç« èŠ‚ ID åŒ¹é…é€»è¾‘</li>
            <li>âœ… å¢å¼ºç”Ÿæˆæµç¨‹çš„é”™è¯¯å¤„ç†</li>
            <li>âœ… æ·»åŠ è¿›åº¦æ¢å¤æœºåˆ¶</li>
            <li>âœ… æ·»åŠ  StateManager é”™è¯¯æ—¥å¿—æ–¹æ³•</li>
            <li>âœ… åˆ›å»ºè°ƒè¯•å·¥å…·</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ” è°ƒè¯•å·¥å…·æµ‹è¯•</h2>

        <div class="test-item">
            <h3>1. æ£€æŸ¥è°ƒè¯•å·¥å…·æ˜¯å¦åŠ è½½</h3>
            <button onclick="testDebugToolLoaded()">æ£€æŸ¥è°ƒè¯•å·¥å…·</button>
            <div id="result-debug-tool" class="result" style="display:none;"></div>
        </div>

        <div class="test-item">
            <h3>2. æ˜¾ç¤ºè°ƒè¯•å·¥å…·å¸®åŠ©</h3>
            <button onclick="showDebugHelp()">æ˜¾ç¤ºå¸®åŠ©</button>
            <div id="result-help" class="result" style="display:none;"></div>
        </div>

        <div class="test-item">
            <h3>3. æµ‹è¯•é”™è¯¯æ—¥å¿—åŠŸèƒ½</h3>
            <button onclick="testErrorLogging()">æµ‹è¯•é”™è¯¯æ—¥å¿—</button>
            <button onclick="viewErrorLogs()">æŸ¥çœ‹é”™è¯¯æ—¥å¿—</button>
            <button class="danger" onclick="clearErrorLogs()">æ¸…é™¤é”™è¯¯æ—¥å¿—</button>
            <div id="result-error-log" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª æ¨¡æ‹Ÿæµ‹è¯•åœºæ™¯</h2>

        <div class="test-item">
            <h3>åœºæ™¯ 1: æ¨¡æ‹Ÿè¿›åº¦æ›´æ–°å¤±è´¥</h3>
            <p>æµ‹è¯•å½“ DOM å…ƒç´ ä¸å­˜åœ¨æ—¶çš„é”™è¯¯å¤„ç†</p>
            <button onclick="testProgressUpdateFail()">è¿è¡Œæµ‹è¯•</button>
            <div id="result-progress-fail" class="result" style="display:none;"></div>
        </div>

        <div class="test-item">
            <h3>åœºæ™¯ 2: æ¨¡æ‹Ÿç« èŠ‚ ID ä¸åŒ¹é…</h3>
            <p>æµ‹è¯•æ¨¡ç³ŠåŒ¹é…é€»è¾‘</p>
            <button onclick="testChapterIdMismatch()">è¿è¡Œæµ‹è¯•</button>
            <div id="result-chapter-mismatch" class="result" style="display:none;"></div>
        </div>

        <div class="test-item">
            <h3>åœºæ™¯ 3: æ£€æŸ¥ StateManager æ–¹æ³•</h3>
            <p>éªŒè¯æ–°å¢çš„é”™è¯¯æ—¥å¿—æ–¹æ³•</p>
            <button onclick="testStateManagerMethods()">è¿è¡Œæµ‹è¯•</button>
            <div id="result-state-manager" class="result" style="display:none;"></div>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ“Š å®Œæ•´è¯Šæ–­</h2>
        <p>è¿è¡Œå®Œæ•´è¯Šæ–­éœ€è¦æœ‰æ´»åŠ¨çš„ç”Ÿæˆä»»åŠ¡ã€‚è¯·å…ˆåœ¨ä¸»åº”ç”¨ä¸­å¼€å§‹ç”Ÿæˆå•†ä¸šè®¡åˆ’ä¹¦ã€‚</p>
        <div>
            <label>Chat ID: <input type="text" id="chatId" placeholder="ä¾‹å¦‚: chat-123" style="padding: 5px; width: 200px;"></label>
            <label>ç±»å‹:
                <select id="reportType" style="padding: 5px;">
                    <option value="business">å•†ä¸šè®¡åˆ’ä¹¦</option>
                    <option value="proposal">äº§å“ç«‹é¡¹ææ–™</option>
                </select>
            </label>
            <button onclick="runFullDiagnosis()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
        </div>
        <div id="result-diagnosis" class="result" style="display:none;"></div>
    </div>

    <script>
        // æµ‹è¯•è°ƒè¯•å·¥å…·æ˜¯å¦åŠ è½½
        function testDebugToolLoaded() {
            const result = document.getElementById('result-debug-tool');
            result.style.display = 'block';

            if (typeof window.debugProgress !== 'undefined') {
                result.className = 'result success';
                result.textContent = 'âœ… è°ƒè¯•å·¥å…·å·²æˆåŠŸåŠ è½½\n\nå¯ç”¨æ–¹æ³•:\n' +
                    Object.keys(window.debugProgress).join('\n- ');
            } else {
                result.className = 'result error';
                result.textContent = 'âŒ è°ƒè¯•å·¥å…·æœªåŠ è½½\n\nè¯·ç¡®ä¿ debug-progress.js å·²æ­£ç¡®å¼•å…¥';
            }
        }

        // æ˜¾ç¤ºè°ƒè¯•å·¥å…·å¸®åŠ©
        function showDebugHelp() {
            const result = document.getElementById('result-help');
            result.style.display = 'block';
            result.className = 'result info';

            if (typeof window.debugProgress !== 'undefined') {
                window.debugProgress.help();
                result.textContent = 'âœ… å¸®åŠ©ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°\n\nè¯·æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·æŸ¥çœ‹';
            } else {
                result.className = 'result error';
                result.textContent = 'âŒ è°ƒè¯•å·¥å…·æœªåŠ è½½';
            }
        }

        // æµ‹è¯•é”™è¯¯æ—¥å¿—åŠŸèƒ½
        function testErrorLogging() {
            const result = document.getElementById('result-error-log');
            result.style.display = 'block';

            if (typeof window.stateManager === 'undefined') {
                result.className = 'result error';
                result.textContent = 'âŒ StateManager æœªåˆå§‹åŒ–';
                return;
            }

            // è®°å½•æµ‹è¯•é”™è¯¯
            window.stateManager.logError('test-error', {
                message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é”™è¯¯',
                timestamp: Date.now(),
                testData: { foo: 'bar' }
            });

            result.className = 'result success';
            result.textContent = 'âœ… é”™è¯¯æ—¥å¿—å·²è®°å½•\n\nè¯·æ‰“å¼€æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯';
        }

        // æŸ¥çœ‹é”™è¯¯æ—¥å¿—
        function viewErrorLogs() {
            const result = document.getElementById('result-error-log');
            result.style.display = 'block';

            if (typeof window.stateManager === 'undefined') {
                result.className = 'result error';
                result.textContent = 'âŒ StateManager æœªåˆå§‹åŒ–';
                return;
            }

            const logs = window.stateManager.getErrorLogs();
            result.className = 'result info';
            result.textContent = `ğŸ“‹ é”™è¯¯æ—¥å¿— (${logs.length} æ¡):\n\n` +
                JSON.stringify(logs, null, 2);
        }

        // æ¸…é™¤é”™è¯¯æ—¥å¿—
        function clearErrorLogs() {
            const result = document.getElementById('result-error-log');
            result.style.display = 'block';

            if (typeof window.stateManager === 'undefined') {
                result.className = 'result error';
                result.textContent = 'âŒ StateManager æœªåˆå§‹åŒ–';
                return;
            }

            window.stateManager.clearErrorLogs();
            result.className = 'result success';
            result.textContent = 'âœ… é”™è¯¯æ—¥å¿—å·²æ¸…é™¤';
        }

        // æµ‹è¯•è¿›åº¦æ›´æ–°å¤±è´¥åœºæ™¯
        function testProgressUpdateFail() {
            const result = document.getElementById('result-progress-fail');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = 'â³ æµ‹è¯•ä¸­...\n\nè¿™ä¸ªæµ‹è¯•éœ€è¦åœ¨ä¸»åº”ç”¨ä¸­è¿è¡Œï¼Œå› ä¸ºéœ€è¦ AgentProgressManager å®ä¾‹ã€‚\n\n' +
                'è¯·åœ¨ä¸»åº”ç”¨ä¸­æ‰“å¼€æ§åˆ¶å°ï¼Œæ‰§è¡Œ:\n' +
                'debugProgress.manualUpdateProgress("non-existent-chapter", "working")';
        }

        // æµ‹è¯•ç« èŠ‚ ID ä¸åŒ¹é…åœºæ™¯
        function testChapterIdMismatch() {
            const result = document.getElementById('result-chapter-mismatch');
            result.style.display = 'block';
            result.className = 'result info';
            result.textContent = 'â³ æµ‹è¯•ä¸­...\n\nè¿™ä¸ªæµ‹è¯•éœ€è¦åœ¨ä¸»åº”ç”¨ä¸­è¿è¡Œã€‚\n\n' +
                'æ¨¡ç³ŠåŒ¹é…é€»è¾‘å·²åœ¨ agent-progress.js çš„ updateProgress æ–¹æ³•ä¸­å®ç°ã€‚\n' +
                'å½“ç« èŠ‚ ID ä¸å®Œå…¨åŒ¹é…æ—¶ï¼Œä¼šå°è¯•æ¨¡ç³ŠåŒ¹é…ã€‚';
        }

        // æµ‹è¯• StateManager æ–¹æ³•
        function testStateManagerMethods() {
            const result = document.getElementById('result-state-manager');
            result.style.display = 'block';

            if (typeof window.stateManager === 'undefined') {
                result.className = 'result error';
                result.textContent = 'âŒ StateManager æœªåˆå§‹åŒ–';
                return;
            }

            const methods = ['logError', 'getErrorLogs', 'clearErrorLogs'];
            const missingMethods = methods.filter(m => typeof window.stateManager[m] !== 'function');

            if (missingMethods.length === 0) {
                result.className = 'result success';
                result.textContent = 'âœ… StateManager æ‰€æœ‰æ–°æ–¹æ³•éƒ½å·²æ­£ç¡®æ·»åŠ :\n\n' +
                    methods.map(m => `- ${m}()`).join('\n');
            } else {
                result.className = 'result error';
                result.textContent = 'âŒ ç¼ºå°‘ä»¥ä¸‹æ–¹æ³•:\n\n' +
                    missingMethods.join('\n');
            }
        }

        // è¿è¡Œå®Œæ•´è¯Šæ–­
        function runFullDiagnosis() {
            const result = document.getElementById('result-diagnosis');
            const chatId = document.getElementById('chatId').value;
            const type = document.getElementById('reportType').value;

            result.style.display = 'block';

            if (!chatId) {
                result.className = 'result error';
                result.textContent = 'âŒ è¯·è¾“å…¥ Chat ID';
                return;
            }

            if (typeof window.debugProgress === 'undefined') {
                result.className = 'result error';
                result.textContent = 'âŒ è°ƒè¯•å·¥å…·æœªåŠ è½½';
                return;
            }

            result.className = 'result info';
            result.textContent = 'â³ è¿è¡Œè¯Šæ–­ä¸­...\n\nè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º';

            // è¿è¡Œè¯Šæ–­
            window.debugProgress.diagnose(chatId, type);

            setTimeout(() => {
                result.textContent += '\n\nâœ… è¯Šæ–­å®Œæˆï¼Œè¯¦ç»†ä¿¡æ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°';
            }, 1000);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('=== å•†ä¸šè®¡åˆ’ä¹¦è¿›åº¦ä¿®å¤æµ‹è¯•é¡µé¢ ===');
            console.log('è°ƒè¯•å·¥å…·çŠ¶æ€:', typeof window.debugProgress !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');
            console.log('StateManager çŠ¶æ€:', typeof window.stateManager !== 'undefined' ? 'âœ… å·²åŠ è½½' : 'âŒ æœªåŠ è½½');
            console.log('');
            console.log('æç¤º: æ‰“å¼€ä¸»åº”ç”¨ (index.html) åï¼Œå¯ä»¥åœ¨æ§åˆ¶å°ä½¿ç”¨ debugProgress å·¥å…·');
        });
    </script>
</body>
</html>
