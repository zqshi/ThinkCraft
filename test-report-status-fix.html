<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报告状态显示修复测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 0;
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .test-case h3 {
            margin-top: 0;
            color: #2196F3;
        }
        .expected {
            background: #e8f5e9;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .steps {
            background: #fff3e0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .steps ol {
            margin: 5px 0;
            padding-left: 20px;
        }
        .code {
            background: #263238;
            color: #aed581;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        .highlight {
            background: #ffeb3b;
            padding: 2px 4px;
            border-radius: 2px;
        }
        .success {
            color: #4CAF50;
            font-weight: bold;
        }
        .warning {
            color: #ff9800;
            font-weight: bold;
        }
        .info {
            background: #e3f2fd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <h1>📋 报告生成状态显示问题修复测试</h1>

    <div class="test-section">
        <h2>🔧 修复内容</h2>
        <div class="info">
            <strong>问题1：</strong>关闭弹窗后再次打开，商业计划书和产品立项材料按钮显示为idle而不是completed<br>
            <strong>问题2：</strong>生成过程中关闭弹窗，再次打开没有显示generating状态
        </div>

        <h3>核心修改</h3>
        <div class="code">
// 修改1: viewReport() 改为异步，等待状态加载完成后再显示弹窗
async function viewReport() {
    const reportModal = document.getElementById('reportModal');

    // 1. 先加载状态（等待完成）
    await loadGenerationStatesForChat(state.currentChat);

    // 2. 再显示弹窗
    if (reportModal) {
        reportModal.classList.add('active');
    }
    // ...
}

// 修改2: 优化 loadGenerationStatesForChat() 的重置时机
async function loadGenerationStatesForChat(chatId) {
    try {
        if (!chatId) {
            resetGenerationButtons();  // 只在无chatId时重置
            return;
        }

        const reports = await window.storageManager.getReportsByChatId(String(chatId));

        // 如果没有报告，重置按钮
        if (!reports || reports.length === 0) {
            resetGenerationButtons();
            return;
        }

        // 有报告时，先重置再更新（避免状态残留）
        resetGenerationButtons();

        // 更新按钮状态...
    }
}
        </div>
    </div>

    <div class="test-section">
        <h2>🧪 测试场景</h2>

        <div class="test-case">
            <h3>测试场景1：已完成状态显示</h3>
            <div class="steps">
                <strong>测试步骤：</strong>
                <ol>
                    <li>生成商业计划书（等待完成）</li>
                    <li>关闭弹窗</li>
                    <li>点击【查看完整报告】</li>
                </ol>
            </div>
            <div class="expected">
                <strong>✅ 预期结果：</strong>
                <ul>
                    <li>商业计划书按钮显示为 <span class="highlight">✅ 商业计划书（查看）</span></li>
                    <li>按钮是绿色，带有完成图标</li>
                    <li><span class="success">无状态闪烁</span>，直接显示completed状态</li>
                </ul>
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景2：生成中状态显示</h3>
            <div class="steps">
                <strong>测试步骤：</strong>
                <ol>
                    <li>开始生成商业计划书</li>
                    <li>生成过程中关闭弹窗</li>
                    <li>点击【查看完整报告】</li>
                </ol>
            </div>
            <div class="expected">
                <strong>✅ 预期结果：</strong>
                <ul>
                    <li>商业计划书按钮显示为 <span class="highlight">⏳ 生成中...</span></li>
                    <li>按钮是橙色，图标旋转</li>
                    <li>显示生成进度（如果有）</li>
                </ul>
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景3：对话切换</h3>
            <div class="steps">
                <strong>测试步骤：</strong>
                <ol>
                    <li>在对话A中生成商业计划书（完成）</li>
                    <li>切换到对话B</li>
                    <li>点击【查看完整报告】</li>
                    <li>切换回对话A</li>
                    <li>点击【查看完整报告】</li>
                </ol>
            </div>
            <div class="expected">
                <strong>✅ 预期结果：</strong>
                <ul>
                    <li>对话B：商业计划书按钮显示为 <span class="highlight">📊 商业计划书</span>（idle状态）</li>
                    <li>对话A：商业计划书按钮显示为 <span class="highlight">✅ 商业计划书（查看）</span>（completed状态）</li>
                    <li>状态在不同对话间正确隔离</li>
                </ul>
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景4：页面刷新</h3>
            <div class="steps">
                <strong>测试步骤：</strong>
                <ol>
                    <li>生成商业计划书（完成）</li>
                    <li>刷新页面（F5）</li>
                    <li>点击【查看完整报告】</li>
                </ol>
            </div>
            <div class="expected">
                <strong>✅ 预期结果：</strong>
                <ul>
                    <li>商业计划书按钮显示为 <span class="highlight">✅ 商业计划书（查看）</span></li>
                    <li>状态从IndexedDB正确恢复</li>
                    <li>无需重新生成</li>
                </ul>
            </div>
        </div>

        <div class="test-case">
            <h3>测试场景5：无状态闪烁验证</h3>
            <div class="steps">
                <strong>测试步骤：</strong>
                <ol>
                    <li>生成商业计划书（完成）</li>
                    <li>点击【查看完整报告】</li>
                    <li><span class="warning">仔细观察</span>弹窗打开瞬间的按钮状态</li>
                </ol>
            </div>
            <div class="expected">
                <strong>✅ 预期结果：</strong>
                <ul>
                    <li>弹窗打开时，按钮<span class="success">直接显示completed状态</span></li>
                    <li><span class="success">不应该</span>先显示idle再变为completed</li>
                    <li>无视觉闪烁或状态跳变</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>🔍 技术细节</h2>

        <h3>修复原理</h3>
        <div class="info">
            <strong>问题根源：</strong>时序竞争问题
            <ul>
                <li>原代码：弹窗立即显示 → 异步加载状态（无await）</li>
                <li>结果：用户看到弹窗时，状态还未加载完成</li>
            </ul>
        </div>

        <div class="info">
            <strong>修复策略：</strong>延迟弹窗显示
            <ul>
                <li>新代码：等待状态加载完成（await） → 再显示弹窗</li>
                <li>结果：弹窗显示时，按钮状态已正确</li>
            </ul>
        </div>

        <h3>性能影响</h3>
        <div class="info">
            <ul>
                <li>状态加载通常很快（&lt;50ms）</li>
                <li>用户感知的延迟应该很小</li>
                <li>如果加载时间&gt;200ms，可以考虑添加加载指示器</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>⚠️ 注意事项</h2>
        <div class="info">
            <ul>
                <li>测试前确保已清除浏览器缓存</li>
                <li>使用开发者工具的Network面板监控请求</li>
                <li>使用Console面板查看日志输出</li>
                <li>测试时注意观察按钮状态的变化时机</li>
                <li>如果发现问题，检查IndexedDB中的数据是否正确</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>📊 测试检查清单</h2>
        <div style="background: white; padding: 15px; border: 1px solid #ddd; border-radius: 4px;">
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox"> 场景1：已完成状态正确显示
            </label>
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox"> 场景2：生成中状态正确显示
            </label>
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox"> 场景3：对话切换状态正确隔离
            </label>
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox"> 场景4：页面刷新状态正确恢复
            </label>
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox"> 场景5：无状态闪烁现象
            </label>
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox"> 性能：弹窗打开延迟可接受（&lt;100ms）
            </label>
            <label style="display: block; margin: 10px 0;">
                <input type="checkbox"> 兼容性：所有浏览器正常工作
            </label>
        </div>
    </div>

    <div class="test-section" style="background: #e8f5e9;">
        <h2>✅ 修复完成</h2>
        <p>修改的文件：<code>frontend/js/app-boot.js</code></p>
        <p>修改的函数：</p>
        <ul>
            <li><code>viewReport()</code> - 行1196-1205</li>
            <li><code>loadGenerationStatesForChat()</code> - 行2576-2594</li>
        </ul>
        <p><strong>下一步：</strong>在实际应用中测试上述场景，验证修复效果。</p>
    </div>
</body>
</html>
