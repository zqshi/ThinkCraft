<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ¸…ç†å‰ç«¯æ•°æ® - ThinkCraft</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 600px;
        width: 100%;
        padding: 40px;
      }

      h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      .warning {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
      }

      .warning strong {
        display: block;
        margin-bottom: 5px;
      }

      .stats {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .stats h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 16px;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
      }

      .stat-item:last-child {
        border-bottom: none;
      }

      .stat-label {
        color: #666;
      }

      .stat-value {
        color: #333;
        font-weight: 600;
      }

      .buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      button {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }

      .btn-scan {
        background: #667eea;
        color: white;
      }

      .btn-scan:hover {
        background: #5568d3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .btn-clear {
        background: #dc3545;
        color: white;
      }

      .btn-clear:hover {
        background: #c82333;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
      }

      .btn-clear:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .log {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        color: #333;
        display: none;
      }

      .log.show {
        display: block;
      }

      .log-item {
        padding: 4px 0;
      }

      .log-success {
        color: #28a745;
      }

      .log-error {
        color: #dc3545;
      }

      .log-info {
        color: #17a2b8;
      }

      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ§¹ æ¸…ç†å‰ç«¯æ•°æ®</h1>
      <p class="subtitle">æŠ•äº§å‰æ•°æ®æ¸…ç†å·¥å…·</p>

      <div class="warning">
        <strong>âš ï¸ è­¦å‘Š</strong>
        æ­¤æ“ä½œå°†æ¸…ç†æµè§ˆå™¨ä¸­çš„æ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ŒåŒ…æ‹¬IndexedDBå’ŒlocalStorageã€‚æ­¤æ“ä½œä¸å¯é€†ï¼
      </div>

      <div class="stats">
        <h3>ğŸ“Š æ•°æ®ç»Ÿè®¡</h3>
        <div class="stat-item">
          <span class="stat-label">å¯¹è¯ (Chats)</span>
          <span class="stat-value" id="stat-chats">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">æŠ¥å‘Š (Reports)</span>
          <span class="stat-value" id="stat-reports">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">é¡¹ç›® (Projects)</span>
          <span class="stat-value" id="stat-projects">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">çµæ„Ÿ (Inspirations)</span>
          <span class="stat-value" id="stat-inspirations">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">çŸ¥è¯†åº“ (Knowledge)</span>
          <span class="stat-value" id="stat-knowledge">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">äº¤ä»˜ç‰© (Artifacts)</span>
          <span class="stat-value" id="stat-artifacts">-</span>
        </div>
      </div>

      <div class="buttons">
        <button class="btn-scan" id="btn-scan" onclick="scanData()">
          <span id="scan-text">æ‰«ææ•°æ®</span>
        </button>
        <button class="btn-clear" id="btn-clear" onclick="clearAllData()" disabled>
          <span id="clear-text">æ¸…ç†æ‰€æœ‰æ•°æ®</span>
        </button>
      </div>

      <div class="log" id="log"></div>
    </div>

    <script>
      let storageManager = null;
      let stats = {};

      // åˆå§‹åŒ–StorageManager
      async function initStorageManager() {
        const dbName = 'ThinkCraft';
        const dbVersion = 7;

        return new Promise((resolve, reject) => {
          const request = indexedDB.open(dbName, dbVersion);

          request.onerror = () => reject(request.error);
          request.onsuccess = () => resolve(request.result);

          request.onupgradeneeded = event => {
            const db = event.target.result;

            // åˆ›å»ºæ‰€æœ‰å¿…è¦çš„å¯¹è±¡å­˜å‚¨
            const stores = [
              'chats',
              'reports',
              'settings',
              'inspirations',
              'knowledge',
              'projects',
              'artifacts'
            ];

            stores.forEach(storeName => {
              if (!db.objectStoreNames.contains(storeName)) {
                db.createObjectStore(storeName, { keyPath: 'id' });
              }
            });
          };
        });
      }

      // è·å–å­˜å‚¨ä¸­çš„æ•°æ®æ•°é‡
      async function getStoreCount(db, storeName) {
        return new Promise((resolve, reject) => {
          try {
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.count();

            request.onsuccess = () => resolve(request.result);
            request.onerror = () => resolve(0); // å¦‚æœå‡ºé”™ï¼Œè¿”å›0
          } catch (error) {
            resolve(0); // å¦‚æœå­˜å‚¨ä¸å­˜åœ¨ï¼Œè¿”å›0
          }
        });
      }

      // æ¸…ç©ºå­˜å‚¨
      async function clearStore(db, storeName) {
        return new Promise((resolve, reject) => {
          try {
            const transaction = db.transaction([storeName], 'readwrite');
            const store = transaction.objectStore(storeName);
            const request = store.clear();

            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          } catch (error) {
            resolve(); // å¦‚æœå­˜å‚¨ä¸å­˜åœ¨ï¼Œç›´æ¥resolve
          }
        });
      }

      // æ·»åŠ æ—¥å¿—
      function addLog(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const logItem = document.createElement('div');
        logItem.className = `log-item log-${type}`;
        logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(logItem);
        logDiv.scrollTop = logDiv.scrollHeight;
        logDiv.classList.add('show');
      }

      // æ‰«ææ•°æ®
      async function scanData() {
        const btnScan = document.getElementById('btn-scan');
        const scanText = document.getElementById('scan-text');

        btnScan.disabled = true;
        scanText.innerHTML = 'æ‰«æä¸­... <span class="loading"></span>';

        try {
          addLog('å¼€å§‹æ‰«ææ•°æ®...', 'info');

          const db = await initStorageManager();

          // æ‰«æIndexedDB
          const stores = ['chats', 'reports', 'projects', 'inspirations', 'knowledge', 'artifacts'];

          for (const storeName of stores) {
            const count = await getStoreCount(db, storeName);
            stats[storeName] = count;
            document.getElementById(`stat-${storeName}`).textContent = count;
            addLog(`${storeName}: ${count} æ¡è®°å½•`, 'info');
          }

          db.close();

          const totalRecords = Object.values(stats).reduce((sum, count) => sum + count, 0);
          addLog(`æ‰«æå®Œæˆï¼å…± ${totalRecords} æ¡è®°å½•`, 'success');

          // å¯ç”¨æ¸…ç†æŒ‰é’®
          document.getElementById('btn-clear').disabled = false;
        } catch (error) {
          addLog(`æ‰«æå¤±è´¥: ${error.message}`, 'error');
          console.error('æ‰«æå¤±è´¥:', error);
        } finally {
          btnScan.disabled = false;
          scanText.textContent = 'é‡æ–°æ‰«æ';
        }
      }

      // æ¸…ç†æ‰€æœ‰æ•°æ®
      async function clearAllData() {
        if (
          !confirm(
            'ç¡®å®šè¦æ¸…ç†æ‰€æœ‰å‰ç«¯æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤ï¼š\n- IndexedDBä¸­çš„æ‰€æœ‰æ•°æ®\n- localStorageä¸­çš„æ‰€æœ‰æ•°æ®\n\næ­¤æ“ä½œä¸å¯é€†ï¼'
          )
        ) {
          return;
        }

        const btnClear = document.getElementById('btn-clear');
        const clearText = document.getElementById('clear-text');

        btnClear.disabled = true;
        clearText.innerHTML = 'æ¸…ç†ä¸­... <span class="loading"></span>';

        try {
          addLog('å¼€å§‹æ¸…ç†æ•°æ®...', 'info');

          const db = await initStorageManager();

          // æ¸…ç†IndexedDB
          const stores = ['chats', 'reports', 'projects', 'inspirations', 'knowledge', 'artifacts'];

          for (const storeName of stores) {
            await clearStore(db, storeName);
            addLog(`å·²æ¸…ç† ${storeName}`, 'success');
            document.getElementById(`stat-${storeName}`).textContent = '0';
          }

          db.close();

          // æ¸…ç†localStorage
          const localStorageKeys = Object.keys(localStorage);
          localStorageKeys.forEach(key => {
            if (key.startsWith('thinkcraft_') || key.startsWith('ThinkCraft')) {
              localStorage.removeItem(key);
              addLog(`å·²æ¸…ç† localStorage: ${key}`, 'success');
            }
          });

          // æ¸…ç©ºæ‰€æœ‰localStorageï¼ˆå¯é€‰ï¼‰
          localStorage.clear();
          addLog('å·²æ¸…ç†æ‰€æœ‰ localStorage', 'success');

          addLog('âœ“ æ¸…ç†å®Œæˆï¼æ‰€æœ‰å‰ç«¯æ•°æ®å·²æ¸…ç©º', 'success');

          alert('æ¸…ç†å®Œæˆï¼\n\næ‰€æœ‰å‰ç«¯æ•°æ®å·²æ¸…ç©ºã€‚\nå»ºè®®åˆ·æ–°é¡µé¢ä»¥ç¡®ä¿åº”ç”¨çŠ¶æ€æ­£ç¡®ã€‚');
        } catch (error) {
          addLog(`æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
          console.error('æ¸…ç†å¤±è´¥:', error);
          alert(`æ¸…ç†å¤±è´¥: ${error.message}`);
        } finally {
          btnClear.disabled = false;
          clearText.textContent = 'æ¸…ç†æ‰€æœ‰æ•°æ®';
        }
      }

      // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰«æ
      window.addEventListener('load', () => {
        setTimeout(() => {
          scanData();
        }, 500);
      });
    </script>
  </body>
</html>
