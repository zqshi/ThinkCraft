# ThinkCraft 外部用户可执行升级方案（细化版）

## 目标与范围
- 面向外部用户可稳定执行：流程阶段、真实测试、真实部署
- 多用户并发安全隔离、可观测、可回滚
- 保持现有交互与交付物结构，新增“真实执行链路”与“运行环境”

## 当前现状摘要
- 流程阶段产物多为模板文档（ARTIFACT_TYPES 对应模板）
- 测试/部署没有真实执行，只生成报告
- 预览入口为“派生预览”，不是生产部署
- 执行链路为同步 API，易超时、缺少隔离

## 总体架构升级
### 1) 任务执行层（异步 + 隔离）
- 将阶段执行从同步 API 改为异步任务（Job Queue）
- 每次执行在隔离环境运行（容器或工作区沙盒）
- 产物与日志归档为正式交付物

### 2) 运行环境层（可重现 + 安全）
- 统一构建镜像或容器池
- 指定可执行命令白名单（test/build/deploy）
- 资源配额 + 超时控制

### 3) 体验层（状态可见 + 失败可追踪）
- 阶段状态：pending/running/success/failed
- 日志可查看、可导出
- 失败提供重试/回滚/跳过

---

## Phase 1（1-2周）：可执行闭环
### 目标
- 测试阶段真实执行
- 部署阶段真实执行
- 前端可见执行状态与日志

### 后端改造
1. 新增任务队列模块
   - 新增 Job 模型：`jobs`（id, projectId, stageId, status, createdAt, logs, artifacts）
   - 新增 Worker：拉取任务执行

2. 扩展 workflow 执行接口
   - `POST /api/workflow/:projectId/execute-stage` 改为创建任务并返回 taskId
   - 新增 `GET /api/workflow/tasks/:taskId` 查询状态

3. 真实测试执行
   - 在测试阶段触发以下命令：
     - 根目录：`npm test`
     - backend：`npm test`（如有）
   - 采集输出日志（stdout/stderr）
   - 产物：生成 `test-report`（真实日志+统计摘要）

4. 真实部署执行
   - 执行 `scripts/start-prod.sh`
   - 自动健康检查（docker compose healthcheck）
   - 产物：生成 `deploy-doc` + `release-notes`，包含真实执行日志

### 前端改造
- 阶段执行按钮 -> 显示“执行中”并可查看日志
- 新增执行日志弹窗 / 任务状态轮询
- 失败提示 + 重试入口

---

## Phase 2（2-4周）：多租户与生产级保障
### 目标
- 多用户隔离
- 资源可控
- 可回滚可审计

### 运行环境升级
- 容器池（复用执行容器）
- 每个任务独立工作区
- 资源限制（CPU / Memory / Timeout）

### 安全与审计
- 仅允许白名单命令执行
- 记录执行日志与审计数据
- 失败自动回滚（docker compose down）

---

## 外部用户前置配置
1. **模型配置**
   - 必须配置 `DEEPSEEK_API_KEY`
2. **环境变量模板**
   - 部署、测试所需环境变量必须配置
3. **容器与权限**
   - 运行 `docker compose` 所需权限
4. **访问出口**
   - 公网域名或反向代理

---

## 交付物升级规则（产物必须真实可执行）
- `test-report` = 实际测试日志 + 统计摘要
- `deploy-doc` = 实际部署日志 + 环境配置信息
- `release-notes` = 真实版本信息 + commit/tag
- `preview` = 可访问 URL

---

## 风险与对策
- **执行超时**：采用异步任务 + 超时控制
- **执行污染**：容器隔离 + 每任务独立 workspace
- **失败不透明**：全日志保存 + 前端可视化

---

## 建议下一步
1. 明确执行环境（本机 / Docker / K8s）
2. 选定任务队列方案（Redis / BullMQ / 简易队列）
3. 确定日志与产物存储方式（本地 / S3）
