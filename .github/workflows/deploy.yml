name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download deployment artifact
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: actions/download-artifact@v3
        with:
          name: deployment-package

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            echo "ğŸš€ Starting deployment..."

            # åˆ‡æ¢åˆ°éƒ¨ç½²ç›®å½•
            cd ${{ secrets.DEPLOY_PATH || '/opt/thinkcraft' }}

            # å¤‡ä»½å½“å‰ç‰ˆæœ¬
            echo "ğŸ“¦ Creating backup..."
            if [ -d "backup" ]; then
              rm -rf backup.old
              mv backup backup.old
            fi
            mkdir -p backup
            cp docker-compose.yml backup/ || true
            cp .env backup/ || true

            # æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨gitéƒ¨ç½²ï¼‰
            if [ -d ".git" ]; then
              echo "ğŸ“¥ Pulling latest code..."
              git fetch --all
              git checkout ${{ github.ref_name || 'main' }}
              git pull origin ${{ github.ref_name || 'main' }}
            fi

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ğŸ³ Pulling Docker images..."
            docker-compose pull

            # åœæ­¢æ—§å®¹å™¨
            echo "ğŸ›‘ Stopping old containers..."
            docker-compose down

            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸš€ Starting new containers..."
            docker-compose up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ Waiting for services to start..."
            sleep 10

            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ Running health checks..."
            if curl -f http://localhost:3000/health > /dev/null 2>&1; then
              echo "âœ… Backend health check passed"
            else
              echo "âŒ Backend health check failed"
              docker-compose logs backend
              exit 1
            fi

            if curl -f http://localhost:80 > /dev/null 2>&1; then
              echo "âœ… Frontend health check passed"
            else
              echo "âŒ Frontend health check failed"
              docker-compose logs frontend
              exit 1
            fi

            # æ˜¾ç¤ºå®¹å™¨çŠ¶æ€
            echo "ğŸ“Š Container status:"
            docker-compose ps

            # æ¸…ç†æ—§é•œåƒ
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f

            echo "âœ… Deployment completed successfully!"

      - name: Verify deployment
        run: |
          echo "ğŸ” Verifying deployment..."

          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 5

          # æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }}:3000/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Backend is healthy"
          else
            echo "âŒ Backend health check failed (HTTP $response)"
            exit 1
          fi

          # æ£€æŸ¥å‰ç«¯å¯è®¿é—®æ€§
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.SERVER_HOST }} || echo "000")
          if [ "$response" = "200" ] || [ "$response" = "301" ] || [ "$response" = "302" ]; then
            echo "âœ… Frontend is accessible"
          else
            echo "âŒ Frontend is not accessible (HTTP $response)"
            exit 1
          fi

          echo "âœ… Deployment verification passed!"

      - name: Rollback on failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            set -e

            echo "âš ï¸ Deployment failed, rolling back..."

            cd ${{ secrets.DEPLOY_PATH || '/opt/thinkcraft' }}

            # åœæ­¢å¤±è´¥çš„å®¹å™¨
            docker-compose down

            # æ¢å¤å¤‡ä»½
            if [ -d "backup" ]; then
              cp backup/docker-compose.yml . || true
              cp backup/.env . || true
            fi

            # é‡å¯æ—§ç‰ˆæœ¬
            docker-compose up -d

            echo "âœ… Rollback completed"

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Deployment to ${{ github.event.inputs.environment || 'production' }} succeeded"
          else
            echo "âŒ Deployment to ${{ github.event.inputs.environment || 'production' }} failed"
          fi
          # TODO: é›†æˆSlack/é’‰é’‰/ä¼ä¸šå¾®ä¿¡é€šçŸ¥
