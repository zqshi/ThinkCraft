<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试新手引导清理功能</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .pass { background: #d4edda; color: #155724; }
    .fail { background: #f8d7da; color: #721c24; }
    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>
  <h1>新手引导清理功能测试</h1>

  <div class="test-section">
    <h2>测试 1: 检查示例项目面板是否存在</h2>
    <button onclick="testMockPanel()">运行测试</button>
    <div id="test1-result"></div>
  </div>

  <div class="test-section">
    <h2>测试 2: 检查示例项目卡片是否存在</h2>
    <button onclick="testMockCard()">运行测试</button>
    <div id="test2-result"></div>
  </div>

  <div class="test-section">
    <h2>测试 3: 模拟创建示例内容并清理</h2>
    <button onclick="testCleanup()">运行测试</button>
    <div id="test3-result"></div>
  </div>

  <div class="test-section">
    <h2>测试 4: 检查页面加载时的自动清理</h2>
    <button onclick="testAutoCleanup()">运行测试</button>
    <div id="test4-result"></div>
  </div>

  <!-- 加载 onboarding-manager 模块 -->
  <script src="frontend/js/modules/onboarding/onboarding-manager.js"></script>

  <script>
    function showResult(elementId, passed, message) {
      const el = document.getElementById(elementId);
      el.className = `test-result ${passed ? 'pass' : 'fail'}`;
      el.textContent = `${passed ? '✅ 通过' : '❌ 失败'}: ${message}`;
    }

    function testMockPanel() {
      const panel = document.getElementById('projectPanel');
      const title = document.getElementById('projectPanelTitle');
      const body = document.getElementById('projectPanelBody');

      if (!panel) {
        showResult('test1-result', true, '项目面板元素不存在（正常）');
        return;
      }

      const hasMockContent = title && title.textContent === '示例项目详情';
      const bodyHasMockContent = body && body.innerHTML.includes('用户洞察平台');

      if (hasMockContent || bodyHasMockContent) {
        showResult('test1-result', false, '发现残留的示例内容！');
      } else {
        showResult('test1-result', true, '没有发现示例内容');
      }
    }

    function testMockCard() {
      const mockCards = document.querySelectorAll('.project-card.onboarding-mock, .project-card[data-project-id="onboarding-mock-project"]');

      if (mockCards.length > 0) {
        showResult('test2-result', false, `发现 ${mockCards.length} 个残留的示例卡片！`);
      } else {
        showResult('test2-result', true, '没有发现示例卡片');
      }
    }

    function testCleanup() {
      // 创建模拟内容
      const panel = document.createElement('div');
      panel.id = 'projectPanel';
      panel.style.display = 'block';

      const title = document.createElement('div');
      title.id = 'projectPanelTitle';
      title.textContent = '示例项目详情';

      const body = document.createElement('div');
      body.id = 'projectPanelBody';
      body.innerHTML = '<div>示例：用户洞察平台</div>';

      panel.appendChild(title);
      panel.appendChild(body);
      document.body.appendChild(panel);

      // 创建模拟卡片
      const card = document.createElement('div');
      card.className = 'project-card onboarding-mock';
      card.dataset.projectId = 'onboarding-mock-project';
      document.body.appendChild(card);

      // 调用清理函数
      if (window.onboardingManager && typeof window.onboardingManager.cleanupMockContent === 'function') {
        window.onboardingManager.cleanupMockContent();

        // 检查是否清理成功（延迟检查确保 DOM 更新）
        setTimeout(() => {
          const panelAfter = document.getElementById('projectPanel');
          const titleAfter = document.getElementById('projectPanelTitle');
          const bodyAfter = document.getElementById('projectPanelBody');
          const cardAfter = document.querySelector('.project-card.onboarding-mock');

          // 检查面板是否被隐藏或清空
          const panelCleaned = !panelAfter ||
                               panelAfter.style.display === 'none' ||
                               (titleAfter && titleAfter.textContent === '') ||
                               (bodyAfter && bodyAfter.innerHTML === '');

          // 检查卡片是否被删除
          const cardCleaned = !cardAfter;

          // 清理测试元素
          if (panelAfter) panelAfter.remove();
          if (cardAfter) cardAfter.remove();

          if (panelCleaned && cardCleaned) {
            showResult('test3-result', true, '清理功能正常工作');
          } else {
            const details = [];
            if (!panelCleaned) details.push('面板未清理');
            if (!cardCleaned) details.push('卡片未清理');
            showResult('test3-result', false, `清理不完整: ${details.join(', ')}`);
          }
        }, 100);
      } else {
        showResult('test3-result', false, 'cleanupMockContent 方法不存在');
      }
    }

    function testAutoCleanup() {
      if (window.onboardingManager) {
        showResult('test4-result', true, 'onboardingManager 已加载，自动清理应该已执行');
      } else {
        showResult('test4-result', false, 'onboardingManager 未加载');
      }
    }

    // 页面加载时自动运行所有测试
    window.addEventListener('load', () => {
      setTimeout(() => {
        testMockPanel();
        testMockCard();
        testAutoCleanup();
      }, 1000);
    });
  </script>
</body>
</html>
